<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>German Trainer</title>
  <style>
    :root{
      --black:#0b0b0f;
      --dark:#1a0b0b;
      --red:#ff0b0b;
      --dark-red:#3a0606;
      --red-light:#ff3d3d;
      --green:#19b56b;
      --yellow:#ffcc00;
      --muted:#bf9a9a;
      --card:#200f0f;
    }
    *{box-sizing:border-box;font-family: 'Segoe UI', Tahoma, Arial, sans-serif}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--black),var(--dark-red));color:var(--muted)}
    .app{max-width:1100px;margin:24px auto;padding:18px;}
    .hidden{display:none !important;}

    /* Navigation */
    .nav-bar{display:flex;gap:12px;margin-bottom:20px;padding-bottom:12px;border-bottom:1px solid rgba(255,11,11,0.2);flex-wrap:wrap}
    .nav-btn{background:transparent;color:#ff9a9a;padding:8px 16px;border-radius:8px;border:1px solid rgba(255,11,11,0.3);cursor:pointer;font-weight:600;transition:all 0.3s;flex:1;min-width:120px;text-align:center}
    .nav-btn:hover{background:rgba(255,11,11,0.1);color:#ffcccc}
    .nav-btn.active{background:var(--red);color:white;border-color:var(--red)}
    
    /* Pages */
    .page{display:none;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:20px;box-shadow:0 6px 18px rgba(23,2,2,0.6);border:1px solid rgba(255,11,11,0.12);min-height:500px}
    .page.active{display:block;animation:fadeIn 0.5s}
    
    /* Editor page */
    .editor-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    @media(max-width:768px){.editor-grid{grid-template-columns:1fr}}
    
    .input-group{margin-bottom:15px}
    h1{color:#ffe6e6;margin:0 0 15px 0;font-size:24px;border-bottom:2px solid rgba(255,11,11,0.3);padding-bottom:8px}
    h2{color:#ffcccc;margin:15px 0 10px 0;font-size:18px}
    label{display:block;margin:8px 0 6px;color:var(--muted);font-size:14px}
    input[type=text], input[type=number], textarea{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.3);color:#ffe6e6;font-size:15px;resize:vertical}
    input[type=text]:focus, input[type=number]:focus, textarea:focus{outline:none;border-color:var(--red-light);box-shadow:0 0 0 2px rgba(255,61,61,0.2)}
    
    .button-group{display:flex;flex-wrap:wrap;gap:8px;margin:15px 0}
    button{background:var(--red);color:white;padding:10px 16px;border-radius:8px;border:none;cursor:pointer;font-weight:600;transition:all 0.2s;font-size:14px}
    button:hover{background:var(--red-light);transform:translateY(-1px)}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.1);color:#ffcccc}
    button.ghost:hover{background:rgba(255,255,255,0.05);border-color:var(--red-light)}
    button.small{font-size:13px;padding:8px 12px}
    button.wide{width:100%}
    
    /* Word list */
    .list-container{margin-top:20px;border:1px solid rgba(255,11,11,0.1);border-radius:8px;overflow:hidden}
    .list-header{background:rgba(255,11,11,0.1);padding:12px;display:flex;justify-content:space-between;color:#ffcccc;font-weight:600}
    .word-list{height:400px;overflow:auto;background:linear-gradient(180deg, rgba(0,0,0,0.3), rgba(0,0,0,0.2))}
    @media(max-width:768px){.word-list{height:300px}}
    
    .word-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid rgba(255,255,255,0.03);transition:background 0.2s}
    .word-item:hover{background:rgba(255,11,11,0.05)}
    .word-content{flex-grow:1}
    .word-text{font-size:16px;color:#ffebeb;font-weight:500}
    .word-meaning{font-size:13px;color:var(--muted);margin-top:4px}
    .word-actions{display:flex;gap:6px;flex-shrink:0}
    
    /* Quiz page */
    .quiz-container{max-width:600px;margin:0 auto}
    .quiz-header{text-align:center;margin-bottom:25px}
    .quiz-stats{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:15px;background:rgba(255,11,11,0.08);border-radius:10px;border:1px solid rgba(255,11,11,0.2)}
    .stat-box{text-align:center}
    .stat-value{font-size:28px;color:#ffebeb;font-weight:bold}
    .stat-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
    
    .quiz-question{background:linear-gradient(90deg, rgba(255,11,11,0.15), rgba(58,6,6,0.15));padding:20px;border-radius:12px;margin-bottom:25px;color:#ffebeb;font-size:20px;text-align:center;min-height:120px;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,11,11,0.2)}
    
    .quiz-options{display:grid;gap:12px;margin-bottom:20px}
    .quiz-option{padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.3);cursor:pointer;text-align:center;font-size:16px;color:#ffebeb;transition:all 0.2s}
    .quiz-option:hover{background:rgba(255,11,11,0.1);border-color:var(--red-light)}
    .quiz-option.correct{background:rgba(25,181,107,0.2);border-color:var(--green);color:#d1ffe9}
    .quiz-option.wrong{background:rgba(255,77,77,0.2);border-color:#ff4d4d;color:#ffd1d1}
    
    .quiz-controls{display:flex;gap:10px;justify-content:center;margin-top:25px}
    
    /* Writing exercise page */
    .writing-container{max-width:600px;margin:0 auto}
    
    .writing-prompt{background:linear-gradient(90deg, rgba(255,11,11,0.1), rgba(58,6,6,0.1));padding:25px;border-radius:12px;margin-bottom:25px;border:2px solid rgba(255,11,11,0.2);text-align:center}
    .writing-prompt-text{font-size:22px;color:#ffcccc;margin-bottom:15px}
    .writing-hint{font-size:14px;color:var(--muted);font-style:italic;margin-top:10px}
    
    .writing-input-container{margin:30px 0}
    .writing-input-label{display:block;margin-bottom:10px;color:#ffcccc;font-size:16px}
    .writing-input{width:100%;padding:15px;font-size:18px;text-align:center;letter-spacing:1px}
    
    .writing-feedback{min-height:60px;margin:20px 0;padding:15px;border-radius:10px;transition:all 0.3s;text-align:center}
    .writing-feedback.correct{background:rgba(25,181,107,0.15);border:1px solid var(--green);color:#d1ffe9}
    .writing-feedback.incorrect{background:rgba(255,77,77,0.15);border:1px solid #ff4d4d;color:#ffd1d1}
    .writing-feedback.show-answer{background:rgba(255,165,0,0.15);border:1px solid #ffa500;color:#fff0d1}
    
    .writing-answer{font-size:22px;color:#ffcccc;font-weight:bold;margin:10px 0}
    
    /* Memory Game page - FIXED FLIP ANIMATION - SMALLER CARDS (HALF SIZE) */
    .memory-container{max-width:800px;margin:0 auto}
    .memory-stats{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding:12px;background:rgba(255,11,11,0.08);border-radius:10px;border:1px solid rgba(255,11,11,0.2)}
    
    .memory-grid{display:grid;grid-template-columns:repeat(8, 1fr);gap:6px;margin:15px auto}
    @media(max-width:1024px){.memory-grid{grid-template-columns:repeat(6, 1fr)}}
    @media(max-width:768px){.memory-grid{grid-template-columns:repeat(5, 1fr);gap:5px}}
    @media(max-width:600px){.memory-grid{grid-template-columns:repeat(4, 1fr);gap:4px}}
    @media(max-width:480px){.memory-grid{grid-template-columns:repeat(3, 1fr);gap:3px}}
    
    .memory-card{
      aspect-ratio:2/3; /* Changed from 3/4 to 2/3 for smaller cards */
      border-radius:6px; /* Smaller radius */
      cursor:pointer;
      transition:all 0.3s;
      position:relative;
      transform-style:preserve-3d;
      perspective:800px; /* Smaller perspective */
      min-height:60px; /* Minimum height */
    }
    
    .memory-card-inner{
      position:relative;
      width:100%;
      height:100%;
      text-align:center;
      transition:transform 0.5s; /* Slightly faster animation */
      transform-style:preserve-3d;
      border-radius:4px; /* Smaller radius */
    }
    
    .memory-card.flipped .memory-card-inner{
      transform:rotateY(180deg);
    }
    
    .memory-card.matched{
      cursor:default;
      opacity:0.7;
    }
    
    .memory-card.matched .card-front{
      background:linear-gradient(145deg, rgba(25,181,107,0.8), rgba(20,150,90,0.8));
      border:1px solid var(--green); /* Thinner border */
    }
    
    .card-front, .card-back{
      position:absolute;
      width:100%;
      height:100%;
      backface-visibility:hidden;
      border-radius:4px; /* Smaller radius */
      display:flex;
      align-items:center;
      justify-content:center;
      padding:4px; /* Much smaller padding */
      text-align:center;
      font-weight:bold;
      -webkit-backface-visibility:hidden;
      backface-visibility:hidden;
    }
    
    .card-back{
      background:linear-gradient(145deg, rgba(255,11,11,0.8), rgba(58,6,6,0.8));
      color:#ffebeb;
      font-size:16px; /* Much smaller font */
      border:1px solid rgba(255,11,11,0.5); /* Thinner border */
    }
    
    .card-front{
      background:linear-gradient(145deg, rgba(0,0,0,0.8), rgba(20,0,0,0.8));
      color:#ffebeb;
      transform:rotateY(180deg);
      font-size:11px; /* Much smaller font */
      line-height:1.2; /* Tighter line height */
      border:1px solid rgba(255,11,11,0.3); /* Thinner border */
      flex-direction:column;
      overflow:hidden; /* Prevent overflow */
    }
    
    .card-flag{
      font-size:12px; /* Much smaller flag */
      margin-bottom:2px;
    }
    
    .card-text{
      font-size:10px; /* Much smaller text */
      word-break:break-word;
      overflow:hidden;
      text-overflow:ellipsis;
      max-height:80%;
    }
    
    .memory-controls{display:flex;gap:8px;justify-content:center;margin-top:20px}
    
    /* Mistake Review page - UPDATED FOR ACTIVE REVIEW */
    .mistakes-container{max-width:800px;margin:0 auto}
    .mistakes-header{text-align:center;margin-bottom:25px}
    
    .mistake-exercise{background:rgba(0,0,0,0.3);border-radius:12px;padding:20px;margin-bottom:20px;border-left:4px solid #ff4d4d}
    .mistake-exercise.corrected{border-left-color:var(--green)}
    .mistake-meta{display:flex;justify-content:space-between;margin-bottom:15px;color:var(--muted);font-size:14px}
    .mistake-type{background:rgba(255,11,11,0.2);padding:4px 8px;border-radius:4px}
    
    .mistake-review-controls{display:flex;gap:10px;justify-content:center;margin-top:20px}
    
    .empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
    .empty-state-icon{font-size:60px;margin-bottom:20px}
    
    /* Active mistake review exercise */
    .mistake-review-exercise{
      background:linear-gradient(180deg, rgba(255,11,11,0.1), rgba(58,6,6,0.1));
      border-radius:12px;
      padding:25px;
      margin:20px 0;
      border:2px solid rgba(255,11,11,0.2);
      display:none;
    }
    
    .mistake-review-exercise.active{
      display:block;
      animation:fadeIn 0.5s;
    }
    
    .mistake-review-question{
      font-size:22px;
      color:#ffcccc;
      text-align:center;
      margin-bottom:20px;
      padding:15px;
      background:rgba(0,0,0,0.2);
      border-radius:10px;
    }
    
    .mistake-review-options{
      display:grid;
      gap:12px;
      margin:20px 0;
    }
    
    .mistake-review-option{
      padding:16px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(0,0,0,0.3);
      cursor:pointer;
      text-align:center;
      font-size:16px;
      color:#ffebeb;
      transition:all 0.2s;
    }
    
    .mistake-review-option:hover{
      background:rgba(255,11,11,0.1);
      border-color:var(--red-light);
    }
    
    .mistake-review-option.correct{
      background:rgba(25,181,107,0.2);
      border-color:var(--green);
      color:#d1ffe9;
    }
    
    .mistake-review-option.wrong{
      background:rgba(255,77,77,0.2);
      border-color:#ff4d4d;
      color:#ffd1d1;
    }
    
    .mistake-review-input-container{
      margin:20px 0;
    }
    
    .mistake-review-input{
      width:100%;
      padding:15px;
      font-size:18px;
      text-align:center;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(0,0,0,0.3);
      color:#ffebeb;
    }
    
    .mistake-review-feedback{
      min-height:60px;
      margin:20px 0;
      padding:15px;
      border-radius:10px;
      transition:all 0.3s;
      text-align:center;
    }
    
    .mistake-review-feedback.correct{
      background:rgba(25,181,107,0.15);
      border:1px solid var(--green);
      color:#d1ffe9;
    }
    
    .mistake-review-feedback.incorrect{
      background:rgba(255,77,77,0.15);
      border:1px solid #ff4d4d;
      color:#ffd1d1;
    }
    
    .mistake-review-progress{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:15px;
      padding:12px;
      background:rgba(255,11,11,0.08);
      border-radius:10px;
    }
    
    .mistake-review-next{
      text-align:center;
      margin-top:20px;
      display:none;
    }
    
    /* Mistakes review */
    .mistakes-section{margin-top:30px;padding-top:20px;border-top:1px solid rgba(255,11,11,0.2)}
    .mistakes-title{color:#ff4d4d;font-size:18px;margin-bottom:15px;display:flex;align-items:center;gap:8px}
    .mistakes-title:before{content:"âš ï¸"}
    
    .mistake-item{margin:12px 0;padding:12px;background:rgba(255,77,77,0.08);border-radius:8px;border-left:3px solid #ff4d4d}
    .mistake-question{color:#ffcccc;font-weight:500;margin-bottom:6px}
    .mistake-answer{display:flex;justify-content:space-between;margin-top:6px;font-size:14px}
    .correct-answer{color:var(--green)}
    .wrong-answer{color:#ff4d4d}
    
    /* Settings */
    .settings-group{margin:20px 0}
    .setting-item{display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(0,0,0,0.2);border-radius:8px;margin:10px 0;flex-wrap:wrap;gap:10px}
    
    /* Exercise selector */
    .exercise-selector{margin:20px 0;padding:15px;background:rgba(255,11,11,0.08);border-radius:10px}
    .exercise-buttons{display:grid;grid-template-columns:repeat(2, 1fr);gap:15px;margin-top:15px}
    @media(max-width:600px){.exercise-buttons{grid-template-columns:1fr}}
    
    .exercise-btn{background:rgba(255,11,11,0.1);border:1px solid rgba(255,11,11,0.3);padding:20px;border-radius:10px;cursor:pointer;transition:all 0.3s;text-align:center}
    .exercise-btn:hover{background:rgba(255,11,11,0.2);transform:translateY(-3px)}
    .exercise-btn .icon{font-size:40px;margin-bottom:10px}
    .exercise-btn .title{font-size:18px;color:#ffcccc;font-weight:bold;margin-bottom:8px}
    .exercise-btn .desc{font-size:13px;color:var(--muted)}
    
    /* Word selection modal */
    .word-selection-modal{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1000;
      padding:20px;
    }
    
    .word-selection-container{
      background:linear-gradient(180deg, var(--black), var(--dark-red));
      border-radius:12px;
      padding:25px;
      max-width:800px;
      width:100%;
      max-height:90vh;
      overflow-y:auto;
      border:2px solid var(--red);
      box-shadow:0 10px 30px rgba(0,0,0,0.5);
    }
    
    .word-selection-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
      padding-bottom:15px;
      border-bottom:2px solid rgba(255,11,11,0.3);
    }
    
    .word-selection-list{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));
      gap:10px;
      margin:20px 0;
      max-height:400px;
      overflow-y:auto;
      padding:10px;
      background:rgba(0,0,0,0.2);
      border-radius:8px;
    }
    
    .word-selection-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px;
      background:rgba(255,11,11,0.05);
      border-radius:6px;
      cursor:pointer;
      transition:all 0.2s;
      border:1px solid rgba(255,255,255,0.05);
    }
    
    .word-selection-item:hover{
      background:rgba(255,11,11,0.1);
      transform:translateY(-2px);
    }
    
    .word-selection-item.selected{
      background:rgba(25,181,107,0.1);
      border-color:var(--green);
    }
    
    .word-selection-item input{
      margin:0;
    }
    
    .word-selection-text{
      flex-grow:1;
    }
    
    .word-selection-german{
      color:#ffebeb;
      font-weight:500;
      font-size:14px;
    }
    
    .word-selection-english{
      color:var(--muted);
      font-size:12px;
    }
    
    .word-selection-controls{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:20px;
      padding-top:20px;
      border-top:1px solid rgba(255,255,255,0.1);
    }
    
    .word-selection-stats{
      color:#ffcccc;
      font-size:14px;
    }
    
    /* Animations */
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}
    @keyframes flip{0%{transform:rotateY(0)}50%{transform:rotateY(90deg)}100%{transform:rotateY(180deg)}}
    @keyframes match{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
    @keyframes shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-5px)}20%,40%,60%,80%{transform:translateX(5px)}}
    
    .shake{animation:shake 0.5s}
    
    footer{text-align:center;margin-top:20px;color:rgba(255,255,255,0.2);font-size:12px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.05)}
  </style>
</head>
<body>
  <div class="app">
    <!-- Navigation -->
    <div class="nav-bar">
      <button class="nav-btn active" data-page="editor">âœï¸ Ù…Ø­Ø±Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª</button>
      <button class="nav-btn" data-page="exercises">ğŸ¯ Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†</button>
      <button class="nav-btn" data-page="quiz">â“ Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªØ¹Ø¯Ø¯</button>
      <button class="nav-btn" data-page="writing">âœï¸ ÙƒØªØ§Ø¨Ø©</button>
      <button class="nav-btn" data-page="memory">ğŸ´ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©</button>
      <button class="nav-btn" data-page="mistakes">ğŸ“Š Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</button>
      <button class="nav-btn" data-page="settings">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>

    <!-- Editor Page -->
    <div class="page active" id="editor-page">
      <div class="editor-grid">
        <div>
          <h1>Ø£Ø¶Ù ÙƒÙ„Ù…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</h1>
          <div class="input-group">
            <label>Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ©</label>
            <input id="german" type="text" placeholder="Ù…Ø«Ø§Ù„: Apfel" />
          </div>
          <div class="input-group">
            <label>Ø§Ù„Ù…Ø¹Ù†Ù‰ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</label>
            <input id="english" type="text" placeholder="Ù…Ø«Ø§Ù„: Apple" />
          </div>
          
          <div class="button-group">
            <button id="add">â• Ø£Ø¶Ù</button>
            <button id="pron" class="ghost">ğŸ”Š Ù†Ø·Ù‚</button>
            <button id="clear-inputs" class="ghost">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          </div>
          
          <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
          <div class="button-group">
            <button id="save" class="ghost">ğŸ’¾ Ø­ÙØ¸ JSON</button>
            <button id="load" class="ghost">ğŸ“‚ ØªØ­Ù…ÙŠÙ„ JSON</button>
            <button id="csv" class="ghost">ğŸ“Š ØªØµØ¯ÙŠØ± CSV</button>
          </div>
        </div>
        
        <div>
          <h1>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª (<span id="wordCount">0</span>)</h1>
          <div class="list-container">
            <div class="list-header">
              <span>ÙƒÙ„Ù…Ø© Ø£Ù„Ù…Ø§Ù†ÙŠØ©</span>
              <span>Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</span>
            </div>
            <div class="word-list" id="wordList"></div>
          </div>
          
          <div class="button-group" style="margin-top:15px">
            <button id="clear-all" class="ghost" style="background:rgba(255,77,77,0.2);color:#ff9999">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
            <button id="shuffle-words" class="ghost">ğŸ”€ Ø¹Ø´ÙˆØ§Ø¦ÙŠ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Exercises Selector Page -->
    <div class="page" id="exercises-page">
      <div class="quiz-container">
        <h1>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</h1>
        
        <div class="exercise-selector">
          <p style="color:#ffcccc; text-align:center; margin-bottom:20px">
            Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ…Ø±ÙŠÙ† Ø§Ù„Ø°ÙŠ ØªØ±ØºØ¨ ÙÙŠ Ù…Ù…Ø§Ø±Ø³ØªÙ‡ Ù„ØªØ­Ø³ÙŠÙ† Ù…Ù‡Ø§Ø±Ø§ØªÙƒ ÙÙŠ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ©.
          </p>
          
          <div class="exercise-buttons">
            <button class="exercise-btn" data-exercise="quiz">
              <div class="icon">â“</div>
              <div class="title">Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªØ¹Ø¯Ø¯</div>
              <div class="desc">Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù…Ù† Ø¨ÙŠÙ† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</div>
            </button>
            
            <button class="exercise-btn" data-exercise="writing">
              <div class="icon">âœï¸</div>
              <div class="title">ØªÙ…Ø±ÙŠÙ† Ø§Ù„ÙƒØªØ§Ø¨Ø©</div>
              <div class="desc">Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© Ø¨Ù†ÙØ³Ùƒ</div>
            </button>
            
            <button class="exercise-btn" data-exercise="memory">
              <div class="icon">ğŸ´</div>
              <div class="title">Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©</div>
              <div class="desc">Ø§Ø·Ø¨Ø¹ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ØªØ·Ø§Ø¨Ù‚Ø©</div>
            </button>
            
            <button class="exercise-btn" data-exercise="mistakes">
              <div class="icon">ğŸ“Š</div>
              <div class="title">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</div>
              <div class="desc">ØªÙ…Ø±Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
            </button>
          </div>
        </div>
        
        <div style="margin-top:30px; padding:20px; background:rgba(255,11,11,0.05); border-radius:10px">
          <h2 style="color:#ffcccc">Ù†ØµØ§Ø¦Ø­ Ù„Ù„ØªØ¹Ù„Ù…</h2>
          <ul style="color:var(--muted); padding-left:20px">
            <li>Ø§Ø¨Ø¯Ø£ Ø¨ØªÙ…Ø±ÙŠÙ† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹Ø±ÙØªÙƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</li>
            <li>Ø§Ø³ØªØ®Ø¯Ù… ØªÙ…Ø±ÙŠÙ† Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ‡Ø¬Ø¦Ø© ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø©</li>
            <li>Ø§Ù„Ø¹Ø¨ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù„ØªØ¹Ø²ÙŠØ² Ø§Ù„Ø±Ø¨Ø· Ø¨ÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø§Øª</li>
            <li>Ø±Ø§Ø¬Ø¹ Ø£Ø®Ø·Ø§Ø¡Ùƒ Ø¨Ø§Ù†ØªØ¸Ø§Ù… Ù„ØªØ­Ø³ÙŠÙ† Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù</li>
            <li>Ø§Ø³ØªÙ…Ø¹ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø·Ù‚ Ù„ØªØ­Ø³ÙŠÙ† Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ ÙˆØ§Ù„Ù†Ø·Ù‚</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Quiz Page -->
    <div class="page" id="quiz-page">
      <div class="quiz-container">
        <h1>Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</h1>
        
        <div class="quiz-stats">
          <div class="stat-box">
            <div class="stat-value" id="quiz-score">0/0</div>
            <div class="stat-label">Ø§Ù„Ù†ØªÙŠØ¬Ø©</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="quiz-remaining">0</div>
            <div class="stat-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="quiz-accuracy">0%</div>
            <div class="stat-label">Ø§Ù„Ø¯Ù‚Ø©</div>
          </div>
        </div>
        
        <div class="quiz-question" id="quiz-prompt">
          Ø£Ø¶Ù ÙƒÙ„Ù…Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±"
        </div>
        
        <div class="quiz-options" id="quiz-opts"></div>
        
        <div class="quiz-controls">
          <button id="start-quiz" style="background:linear-gradient(135deg, var(--red), #ff3d3d);padding:12px 30px;font-size:16px">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
          <button id="select-words-quiz" class="ghost">ğŸ“ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª</button>
          <button id="next-question" class="ghost" style="display:none">â­ï¸ Ø§Ù„ØªØ§Ù„ÙŠ</button>
          <button id="end-quiz" class="ghost" style="display:none">â¹ï¸ Ø¥Ù†Ù‡Ø§Ø¡</button>
          <button id="back-to-exercises-quiz" class="ghost">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        </div>
        
        <div id="quiz-mistakes-container" style="display:none">
          <div class="mistakes-section">
            <h2 class="mistakes-title">Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ (<span id="quiz-mistakes-count">0</span>)</h2>
            <div id="quiz-mistakes-list"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Writing Exercise Page -->
    <div class="page" id="writing-page">
      <div class="writing-container">
        <h1>ØªÙ…Ø±ÙŠÙ† Ø§Ù„ÙƒØªØ§Ø¨Ø©</h1>
        
        <div class="quiz-stats">
          <div class="stat-box">
            <div class="stat-value" id="writing-score">0/0</div>
            <div class="stat-label">Ø§Ù„Ù†ØªÙŠØ¬Ø©</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="writing-remaining">0</div>
            <div class="stat-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="writing-accuracy">0%</div>
            <div class="stat-label">Ø§Ù„Ø¯Ù‚Ø©</div>
          </div>
        </div>
        
        <div class="writing-prompt">
          <div class="writing-prompt-text" id="writing-prompt">
            Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ…Ø±ÙŠÙ†" Ù„Ø¨Ø¯Ø¡ ØªÙ…Ø±ÙŠÙ† Ø§Ù„ÙƒØªØ§Ø¨Ø©
          </div>
          <div class="writing-hint" id="writing-hint">
            Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù…Ø¹Ù†Ù‰ Ø§Ù„Ù…Ø¹Ø·Ù‰
          </div>
        </div>
        
        <div class="writing-input-container">
          <label class="writing-input-label" id="writing-input-label">Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© Ù‡Ù†Ø§:</label>
          <input type="text" class="writing-input" id="writing-input" placeholder="...Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ" disabled />
        </div>
        
        <div class="writing-feedback" id="writing-feedback"></div>
        
        <div class="quiz-controls">
          <button id="start-writing" style="background:linear-gradient(135deg, var(--red), #ff3d3d);padding:12px 30px;font-size:16px">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</button>
          <button id="select-words-writing" class="ghost">ğŸ“ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª</button>
          <button id="check-answer" class="ghost" style="display:none">âœ“ ØªØ­Ù‚Ù‚</button>
          <button id="next-writing" class="ghost" style="display:none">â­ï¸ Ø§Ù„ØªØ§Ù„ÙŠ</button>
          <button id="show-answer" class="ghost" style="display:none">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
          <button id="end-writing" class="ghost" style="display:none">â¹ï¸ Ø¥Ù†Ù‡Ø§Ø¡</button>
          <button id="back-to-exercises-writing" class="ghost">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        </div>
        
        <div id="writing-mistakes-container" style="display:none">
          <div class="mistakes-section">
            <h2 class="mistakes-title">Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ (<span id="writing-mistakes-count">0</span>)</h2>
            <div id="writing-mistakes-list"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Memory Game Page - FIXED FLIP ANIMATION -->
    <div class="page" id="memory-page">
      <div class="memory-container">
        <h1>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© ğŸ´</h1>
        
        <div class="memory-stats">
          <div class="stat-box">
            <div class="stat-value" id="memory-moves">0</div>
            <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø±ÙƒØ§Øª</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="memory-matched">0</div>
            <div class="stat-label">Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="memory-time">0:00</div>
            <div class="stat-label">Ø§Ù„ÙˆÙ‚Øª</div>
          </div>
        </div>
        
        <div class="memory-grid" id="memory-grid">
          <div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted)">
            Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©" Ù„Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©
          </div>
        </div>
        
        <div class="memory-controls">
          <button id="start-memory" style="background:linear-gradient(135deg, var(--red), #ff3d3d);padding:12px 30px;font-size:16px">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
          <button id="select-words-memory" class="ghost">ğŸ“ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª</button>
          <button id="restart-memory" class="ghost" style="display:none">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„</button>
          <button id="back-to-exercises-memory" class="ghost">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        </div>
        
        <div id="memory-complete" style="display:none;text-align:center;margin-top:30px;padding:20px;background:rgba(25,181,107,0.1);border-radius:10px;border:1px solid var(--green)">
          <div style="font-size:48px">ğŸ‰</div>
          <div style="font-size:24px;color:#ffcccc;margin:10px 0">Ø£Ø­Ø³Ù†Øª! Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</div>
          <div style="color:var(--muted)">Ø­Ø±ÙƒØ§Øª: <span id="final-moves">0</span> | ÙˆÙ‚Øª: <span id="final-time">0:00</span></div>
          <button class="ghost" style="margin-top:15px" onclick="restartMemoryGame()">ğŸ”„ Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
        </div>
      </div>
    </div>

    <!-- Mistake Review Page - UPDATED FOR ACTIVE REVIEW -->
    <div class="page" id="mistakes-page">
      <div class="mistakes-container">
        <h1>ğŸ“Š Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</h1>
        
        <div class="quiz-stats">
          <div class="stat-box">
            <div class="stat-value" id="total-mistakes">0</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="corrected-mistakes">0</div>
            <div class="stat-label">Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…ØµØ­Ø­Ø©</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="accuracy-mistakes">0%</div>
            <div class="stat-label">Ø¯Ù‚Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
          </div>
        </div>
        
        <!-- Active Review Exercise Container -->
        <div class="mistake-review-exercise" id="mistake-review-exercise">
          <div class="mistake-review-question" id="mistake-review-question"></div>
          
          <!-- For quiz-type mistakes -->
          <div class="mistake-review-options" id="mistake-review-options"></div>
          
          <!-- For writing-type mistakes -->
          <div class="mistake-review-input-container" id="mistake-review-input-container" style="display:none">
            <input type="text" class="mistake-review-input" id="mistake-review-input" placeholder="...Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ" />
            <div style="text-align:center;margin-top:15px">
              <button id="check-mistake-answer" class="ghost">âœ“ ØªØ­Ù‚Ù‚</button>
            </div>
          </div>
          
          <div class="mistake-review-feedback" id="mistake-review-feedback"></div>
          
          <div class="mistake-review-progress">
            <div>
              <div style="font-size:12px;color:var(--muted)">Ø§Ù„ØªÙ‚Ø¯Ù…</div>
              <div style="font-size:16px;color:#ffcccc">
                <span id="current-mistake-progress">0</span>/<span id="total-mistakes-to-review">0</span>
              </div>
            </div>
            <div>
              <div style="font-size:12px;color:var(--muted)">Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</div>
              <div style="font-size:16px;color:#ffcccc">
                <span id="current-corrected-count">0</span>/<span id="needs-correct-count">2</span>
              </div>
            </div>
          </div>
          
          <div class="mistake-review-next" id="mistake-review-next">
            <button id="next-mistake" class="ghost">â­ï¸ Ø§Ù„ØªØ§Ù„ÙŠ</button>
          </div>
        </div>
        
        <!-- Mistakes List Container -->
        <div id="mistakes-list-container">
          <!-- Mistakes will be dynamically inserted here -->
        </div>
        
        <div id="no-mistakes" class="empty-state" style="display:none">
          <div class="empty-state-icon">âœ…</div>
          <h2 style="color:#ffcccc">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©!</h2>
          <p style="color:var(--muted);margin-top:10px">Ø§Ø³ØªÙ…Ø± ÙÙŠ Ù…Ù…Ø§Ø±Ø³Ø© Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†ØŒ ÙˆØ³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
          <button class="ghost" style="margin-top:20px" onclick="document.querySelector('[data-page=\"exercises\"]').click()">ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</button>
        </div>
        
        <div class="mistake-review-controls">
          <button id="start-mistakes-review" class="ghost">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
          <button id="clear-corrected-mistakes" class="ghost">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…ØµØ­Ø­Ø©</button>
          <button id="clear-all-mistakes" class="ghost" style="background:rgba(255,77,77,0.2);color:#ff9999">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</button>
          <button id="stop-mistakes-review" class="ghost" style="display:none">â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
        </div>
      </div>
    </div>

    <!-- Settings Page -->
    <div class="page" id="settings-page">
      <h1>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h1>
      
      <div class="settings-group">
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†</h2>
        <div class="setting-item">
          <span>Ø¹Ø¯Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</span>
          <select id="optionsCount" style="background:rgba(0,0,0,0.3);color:#ffebeb;border:1px solid rgba(255,255,255,0.1);padding:6px 10px;border-radius:6px">
            <option value="2">2 Ø®ÙŠØ§Ø±Ø§Øª</option>
            <option value="3">3 Ø®ÙŠØ§Ø±Ø§Øª</option>
            <option value="4" selected>4 Ø®ÙŠØ§Ø±Ø§Øª</option>
            <option value="5">5 Ø®ÙŠØ§Ø±Ø§Øª</option>
            <option value="6">6 Ø®ÙŠØ§Ø±Ø§Øª</option>
          </select>
        </div>
        
        <div class="setting-item">
          <span>Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙÙŠ Ø§Ù„ØªÙ…Ø±ÙŠÙ†:</span>
          <input type="number" id="exerciseLimit" min="5" max="100" value="20" style="width:80px;text-align:center" />
        </div>
        
        <div class="setting-item">
          <span>Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:</span>
          <label style="cursor:pointer">
            <input type="checkbox" id="usePron" checked />
            <span style="margin-left:8px">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø·Ù‚ Ø¹Ù†Ø¯ ÙƒÙ„ Ø³Ø¤Ø§Ù„</span>
          </label>
        </div>
      </div>
      
      <div class="settings-group">
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨Ø©</h2>
        <div class="setting-item">
          <span>ØªØ³Ø§Ù…Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¥Ù…Ù„Ø§Ø¦ÙŠØ©:</span>
          <label style="cursor:pointer">
            <input type="checkbox" id="spellingTolerance" checked />
            <span style="margin-left:8px">ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¥Ù…Ù„Ø§Ø¦ÙŠØ© Ø§Ù„Ø¨Ø³ÙŠØ·Ø©</span>
          </label>
        </div>
        
        <div class="setting-item">
          <span>Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹:</span>
          <label style="cursor:pointer">
            <input type="checkbox" id="autoShowAnswer" />
            <span style="margin-left:8px">Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø®Ø·Ø£</span>
          </label>
        </div>
      </div>
      
      <div class="settings-group">
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</h2>
        <div class="setting-item">
          <span>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù„Ù„Ø¥Ø²Ø§Ù„Ø©:</span>
          <input type="number" id="mistakesToRemove" min="1" max="5" value="2" style="width:80px;text-align:center" />
          <span style="font-size:12px;color:var(--muted)">(Ù…Ø±Ø§Øª Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©)</span>
        </div>
      </div>
      
      <div class="settings-group">
        <h2>Ø§Ù„Ù…Ø¸Ù‡Ø±</h2>
        <div class="setting-item">
          <span>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ:</span>
          <input type="color" id="themeColor" value="#ff0b0b" style="width:40px;height:30px;border:none;background:none;cursor:pointer" />
        </div>
      </div>
      
      <div class="button-group" style="margin-top:30px">
        <button id="reset-settings" class="ghost">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·</button>
        <button id="export-data" class="ghost">ğŸ“¦ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
      </div>
    </div>

    <!-- Word Selection Modal -->
    <div id="word-selection-modal" class="word-selection-modal hidden">
      <div class="word-selection-container">
        <div class="word-selection-header">
          <h1 id="modal-title" style="color:#ffcccc;margin:0">Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù„Ù„ØªÙ…Ø±ÙŠÙ†</h1>
          <button id="close-modal" class="ghost" style="font-size:20px;padding:5px 10px">âœ•</button>
        </div>
        
        <div style="display:flex;gap:15px;margin-bottom:15px;flex-wrap:wrap">
          <button id="select-all" class="ghost small">âœ“ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
          <button id="deselect-all" class="ghost small">âœ— Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
          <button id="select-last" class="ghost small">ğŸ“… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø®ÙŠØ±Ø©</button>
          <button id="select-random" class="ghost small">ğŸ² Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ</button>
        </div>
        
        <div class="word-selection-list" id="word-selection-list">
          <!-- Words will be inserted here -->
        </div>
        
        <div class="word-selection-controls">
          <div class="word-selection-stats">
            ØªÙ… ØªØ­Ø¯ÙŠØ¯ <span id="selected-count">0</span> Ù…Ù† <span id="total-count">0</span> ÙƒÙ„Ù…Ø©
          </div>
          <div>
            <button id="cancel-selection" class="ghost">Ø¥Ù„ØºØ§Ø¡</button>
            <button id="confirm-selection" style="margin-left:10px">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</button>
          </div>
        </div>
      </div>
    </div>

    <footer>German Trainer â€” Ù…Ù„Ù HTML ÙˆØ§Ø­Ø¯ ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ | ÙŠØ¯Ø¹Ù… Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙˆØ§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ§Ù„ØªØµØ¯ÙŠØ±</footer>
  </div>

  <!-- Hidden file input -->
  <input id="fileInput" type="file" accept="application/json" style="display:none" />

  <script>
    // Data & storage
    const WORDS_KEY = 'german_trainer_words_v4';
    const SETTINGS_KEY = 'german_trainer_settings';
    const MISTAKES_KEY = 'german_trainer_mistakes';
    const SELECTED_WORDS_KEY = 'german_trainer_selected_words';
    
    let words = JSON.parse(localStorage.getItem(WORDS_KEY) || '[]');
    let settings = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{"optionsCount":4,"usePron":true,"exerciseLimit":20,"spellingTolerance":true,"autoShowAnswer":false,"mistakesToRemove":2,"themeColor":"#ff0b0b"}');
    let mistakes = JSON.parse(localStorage.getItem(MISTAKES_KEY) || '[]');
    let selectedWords = JSON.parse(localStorage.getItem(SELECTED_WORDS_KEY) || '[]');
    
    // Game variables
    let quizQueue = [];
    let writingQueue = [];
    let memoryCards = [];
    let currentQuizWord = null;
    let currentWritingWord = null;
    let quizCorrect = 0, quizAttempts = 0;
    let writingCorrect = 0, writingAttempts = 0;
    let quizMistakes = [];
    let writingMistakes = [];
    let quizActive = false;
    let writingActive = false;
    let memoryActive = false;
    let memoryMoves = 0;
    let memoryMatched = 0;
    let memoryStartTime = 0;
    let memoryTimer = null;
    let flippedCards = [];
    let canFlip = true;
    
    // Mistakes review variables
    let currentMistakeReview = null;
    let mistakesReviewQueue = [];
    let mistakesReviewActive = false;
    let currentMistakeIndex = 0;

    // Word selection variables
    let currentExerciseType = null;
    let wordSelectionModal = document.getElementById('word-selection-modal');
    let modalTitle = document.getElementById('modal-title');
    let wordSelectionList = document.getElementById('word-selection-list');
    let selectedCountEl = document.getElementById('selected-count');
    let totalCountEl = document.getElementById('total-count');
    let selectAllBtn = document.getElementById('select-all');
    let deselectAllBtn = document.getElementById('deselect-all');
    let selectLastBtn = document.getElementById('select-last');
    let selectRandomBtn = document.getElementById('select-random');
    let cancelSelectionBtn = document.getElementById('cancel-selection');
    let confirmSelectionBtn = document.getElementById('confirm-selection');
    let closeModalBtn = document.getElementById('close-modal');

    // UI refs
    const germanInput = document.getElementById('german');
    const englishInput = document.getElementById('english');
    const addBtn = document.getElementById('add');
    const pronBtn = document.getElementById('pron');
    const listEl = document.getElementById('wordList');
    const wordCountEl = document.getElementById('wordCount');
    const saveBtn = document.getElementById('save');
    const loadBtn = document.getElementById('load');
    const csvBtn = document.getElementById('csv');
    const clearAllBtn = document.getElementById('clear-all');
    const clearInputsBtn = document.getElementById('clear-inputs');
    const shuffleWordsBtn = document.getElementById('shuffle-words');
    
    // Quiz elements
    const startQuizBtn = document.getElementById('start-quiz');
    const selectWordsQuizBtn = document.getElementById('select-words-quiz');
    const nextQuizBtn = document.getElementById('next-question');
    const endQuizBtn = document.getElementById('end-quiz');
    const optsCount = document.getElementById('optionsCount');
    const exerciseLimit = document.getElementById('exerciseLimit');
    const mistakesToRemove = document.getElementById('mistakesToRemove');
    const themeColor = document.getElementById('themeColor');
    const spellingTolerance = document.getElementById('spellingTolerance');
    const autoShowAnswer = document.getElementById('autoShowAnswer');
    const quizOptsEl = document.getElementById('quiz-opts');
    const quizPromptEl = document.getElementById('quiz-prompt');
    const quizScoreEl = document.getElementById('quiz-score');
    const quizRemainingEl = document.getElementById('quiz-remaining');
    const quizAccuracyEl = document.getElementById('quiz-accuracy');
    const quizMistakesContainer = document.getElementById('quiz-mistakes-container');
    const quizMistakesList = document.getElementById('quiz-mistakes-list');
    const quizMistakesCount = document.getElementById('quiz-mistakes-count');
    
    // Writing elements
    const startWritingBtn = document.getElementById('start-writing');
    const selectWordsWritingBtn = document.getElementById('select-words-writing');
    const checkAnswerBtn = document.getElementById('check-answer');
    const nextWritingBtn = document.getElementById('next-writing');
    const showAnswerBtn = document.getElementById('show-answer');
    const endWritingBtn = document.getElementById('end-writing');
    const writingPromptEl = document.getElementById('writing-prompt');
    const writingHintEl = document.getElementById('writing-hint');
    const writingInput = document.getElementById('writing-input');
    const writingFeedback = document.getElementById('writing-feedback');
    const writingScoreEl = document.getElementById('writing-score');
    const writingRemainingEl = document.getElementById('writing-remaining');
    const writingAccuracyEl = document.getElementById('writing-accuracy');
    const writingMistakesContainer = document.getElementById('writing-mistakes-container');
    const writingMistakesList = document.getElementById('writing-mistakes-list');
    const writingMistakesCount = document.getElementById('writing-mistakes-count');
    
    // Memory game elements
    const startMemoryBtn = document.getElementById('start-memory');
    const selectWordsMemoryBtn = document.getElementById('select-words-memory');
    const restartMemoryBtn = document.getElementById('restart-memory');
    const memoryGrid = document.getElementById('memory-grid');
    const memoryMovesEl = document.getElementById('memory-moves');
    const memoryMatchedEl = document.getElementById('memory-matched');
    const memoryTimeEl = document.getElementById('memory-time');
    const memoryComplete = document.getElementById('memory-complete');
    const finalMovesEl = document.getElementById('final-moves');
    const finalTimeEl = document.getElementById('final-time');
    
    // Mistakes review elements - UPDATED
    const mistakesListContainer = document.getElementById('mistakes-list-container');
    const noMistakesEl = document.getElementById('no-mistakes');
    const totalMistakesEl = document.getElementById('total-mistakes');
    const correctedMistakesEl = document.getElementById('corrected-mistakes');
    const accuracyMistakesEl = document.getElementById('accuracy-mistakes');
    const startMistakesReviewBtn = document.getElementById('start-mistakes-review');
    const clearCorrectedMistakesBtn = document.getElementById('clear-corrected-mistakes');
    const clearAllMistakesBtn = document.getElementById('clear-all-mistakes');
    const stopMistakesReviewBtn = document.getElementById('stop-mistakes-review');
    
    // New mistake review elements
    const mistakeReviewExercise = document.getElementById('mistake-review-exercise');
    const mistakeReviewQuestion = document.getElementById('mistake-review-question');
    const mistakeReviewOptions = document.getElementById('mistake-review-options');
    const mistakeReviewInputContainer = document.getElementById('mistake-review-input-container');
    const mistakeReviewInput = document.getElementById('mistake-review-input');
    const checkMistakeAnswerBtn = document.getElementById('check-mistake-answer');
    const mistakeReviewFeedback = document.getElementById('mistake-review-feedback');
    const currentMistakeProgress = document.getElementById('current-mistake-progress');
    const totalMistakesToReview = document.getElementById('total-mistakes-to-review');
    const currentCorrectedCount = document.getElementById('current-corrected-count');
    const needsCorrectCount = document.getElementById('needs-correct-count');
    const mistakeReviewNext = document.getElementById('mistake-review-next');
    const nextMistakeBtn = document.getElementById('next-mistake');
    
    // Navigation
    const navBtns = document.querySelectorAll('.nav-btn');
    const pages = document.querySelectorAll('.page');
    const exerciseBtns = document.querySelectorAll('.exercise-btn');
    const backToExercisesQuizBtn = document.getElementById('back-to-exercises-quiz');
    const backToExercisesWritingBtn = document.getElementById('back-to-exercises-writing');
    const backToExercisesMemoryBtn = document.getElementById('back-to-exercises-memory');
    
    // File input
    const fileInput = document.getElementById('fileInput');

    // ===== CORE FUNCTIONS =====
    
    // Initialize settings
    function initSettings() {
      optsCount.value = settings.optionsCount || 4;
      document.getElementById('usePron').checked = settings.usePron !== false;
      exerciseLimit.value = settings.exerciseLimit || 20;
      spellingTolerance.checked = settings.spellingTolerance !== false;
      autoShowAnswer.checked = settings.autoShowAnswer || false;
      mistakesToRemove.value = settings.mistakesToRemove || 2;
      themeColor.value = settings.themeColor || '#ff0b0b';
      updateTheme();
    }

    function updateTheme() {
      const root = document.documentElement;
      root.style.setProperty('--red', settings.themeColor);
      root.style.setProperty('--red-light', lightenColor(settings.themeColor, 30));
      root.style.setProperty('--dark-red', darkenColor(settings.themeColor, 40));
    }

    function lightenColor(color, percent) {
      const num = parseInt(color.replace('#', ''), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) + amt;
      const G = (num >> 8 & 0x00FF) + amt;
      const B = (num & 0x0000FF) + amt;
      return '#' + (
        0x1000000 +
        (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
        (B < 255 ? B < 1 ? 0 : B : 255)
      ).toString(16).slice(1);
    }

    function darkenColor(color, percent) {
      const num = parseInt(color.replace('#', ''), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) - amt;
      const G = (num >> 8 & 0x00FF) - amt;
      const B = (num & 0x0000FF) - amt;
      return '#' + (
        0x1000000 +
        (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
        (B < 255 ? B < 1 ? 0 : B : 255)
      ).toString(16).slice(1);
    }

    // Save settings
    function saveSettings() {
      settings.optionsCount = parseInt(optsCount.value);
      settings.usePron = document.getElementById('usePron').checked;
      settings.exerciseLimit = parseInt(exerciseLimit.value);
      settings.spellingTolerance = spellingTolerance.checked;
      settings.autoShowAnswer = autoShowAnswer.checked;
      settings.mistakesToRemove = parseInt(mistakesToRemove.value);
      settings.themeColor = themeColor.value;
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      updateTheme();
    }

    // Save selected words
    function saveSelectedWords() {
      localStorage.setItem(SELECTED_WORDS_KEY, JSON.stringify(selectedWords));
    }

    // Save mistakes
    function saveMistakes() {
      localStorage.setItem(MISTAKES_KEY, JSON.stringify(mistakes));
      updateMistakesStats();
      renderMistakesList();
    }

    // Add a mistake
    function addMistake(exerciseType, question, correctAnswer, wrongAnswer) {
      const mistake = {
        id: Date.now() + Math.random(),
        type: exerciseType,
        question: question,
        correct: correctAnswer,
        wrong: wrongAnswer,
        date: new Date().toISOString(),
        correctedCount: 0,
        needsCorrectCount: settings.mistakesToRemove || 2,
        lastAttempt: null
      };
      
      // Check if similar mistake already exists
      const existingIndex = mistakes.findIndex(m => 
        m.type === exerciseType && 
        m.question === question && 
        m.correct === correctAnswer
      );
      
      if (existingIndex !== -1) {
        // Update existing mistake
        mistakes[existingIndex].wrong = wrongAnswer;
        mistakes[existingIndex].date = new Date().toISOString();
        mistakes[existingIndex].correctedCount = 0;
        mistakes[existingIndex].lastAttempt = 'wrong';
      } else {
        // Add new mistake
        mistakes.push(mistake);
      }
      
      saveMistakes();
    }

    // Update mistake stats
    function updateMistakesStats() {
      const total = mistakes.length;
      const corrected = mistakes.filter(m => m.correctedCount >= m.needsCorrectCount).length;
      const accuracy = total > 0 ? Math.round((corrected / total) * 100) : 0;
      
      totalMistakesEl.textContent = total;
      correctedMistakesEl.textContent = corrected;
      accuracyMistakesEl.textContent = `${accuracy}%`;
      
      if (total === 0) {
        noMistakesEl.style.display = 'block';
        mistakesListContainer.innerHTML = '';
        startMistakesReviewBtn.style.display = 'inline-block';
        stopMistakesReviewBtn.style.display = 'none';
      } else {
        noMistakesEl.style.display = 'none';
        startMistakesReviewBtn.style.display = 'inline-block';
      }
    }

    // Render mistakes list
    function renderMistakesList() {
      mistakesListContainer.innerHTML = '';
      
      if (mistakes.length === 0) return;
      
      // Sort by date (newest first)
      const sortedMistakes = [...mistakes].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      sortedMistakes.forEach((mistake, index) => {
        const isCorrected = mistake.correctedCount >= mistake.needsCorrectCount;
        const exerciseDiv = document.createElement('div');
        exerciseDiv.className = `mistake-exercise ${isCorrected ? 'corrected' : ''}`;
        exerciseDiv.dataset.mistakeId = mistake.id;
        
        const typeLabels = {
          'quiz': 'â“ Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªØ¹Ø¯Ø¯',
          'writing': 'âœï¸ ÙƒØªØ§Ø¨Ø©',
          'memory': 'ğŸ´ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©'
        };
        
        exerciseDiv.innerHTML = `
          <div class="mistake-meta">
            <span class="mistake-type">${typeLabels[mistake.type] || mistake.type}</span>
            <span>${new Date(mistake.date).toLocaleDateString('ar-SA')}</span>
          </div>
          <div style="margin-bottom:10px">
            <strong style="color:#ffcccc">${escapeHtml(mistake.question)}</strong>
          </div>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px">
            <div>
              <div style="color:#19b56b;font-size:14px">âœ… ${escapeHtml(mistake.correct)}</div>
              <div style="color:#ff4d4d;font-size:14px">âŒ ${escapeHtml(mistake.wrong)}</div>
            </div>
            <div style="text-align:center">
              <div style="font-size:12px;color:var(--muted)">Ø§Ù„ØªÙ‚Ø¯Ù…</div>
              <div style="font-size:16px;color:#ffcccc">
                ${mistake.correctedCount}/${mistake.needsCorrectCount}
              </div>
            </div>
          </div>
          <div style="text-align:center; margin-top:10px">
            <button class="small ghost" onclick="reviewSingleMistake('${mistake.id}')" title="Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‡Ø°Ø§ Ø§Ù„Ø®Ø·Ø£">ğŸ”„ Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
          </div>
        `;
        
        mistakesListContainer.appendChild(exerciseDiv);
      });
    }

    // Review a single mistake
    window.reviewSingleMistake = function(mistakeId) {
      const mistake = mistakes.find(m => m.id == mistakeId);
      if (!mistake) return;
      
      currentMistakeReview = mistake;
      mistakesReviewQueue = [mistake];
      currentMistakeIndex = 0;
      
      // Hide mistakes list
      mistakesListContainer.style.display = 'none';
      startMistakesReviewBtn.style.display = 'none';
      stopMistakesReviewBtn.style.display = 'inline-block';
      
      // Show exercise
      mistakeReviewExercise.classList.add('active');
      loadMistakeForReview();
    };

    // ===== WORD SELECTION FUNCTIONS =====
    function openWordSelectionModal(exerciseType) {
      currentExerciseType = exerciseType;
      
      // Set modal title based on exercise type
      const titles = {
        'quiz': 'Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªØ¹Ø¯Ø¯',
        'writing': 'Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù„ØªÙ…Ø±ÙŠÙ† Ø§Ù„ÙƒØªØ§Ø¨Ø©',
        'memory': 'Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©'
      };
      
      modalTitle.textContent = titles[exerciseType] || 'Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù„Ù„ØªÙ…Ø±ÙŠÙ†';
      
      // Render word selection list
      renderWordSelectionList();
      
      // Show modal
      wordSelectionModal.classList.remove('hidden');
    }

    function renderWordSelectionList() {
      wordSelectionList.innerHTML = '';
      totalCountEl.textContent = words.length;
      
      if (words.length === 0) {
        wordSelectionList.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª. Ø£Ø¶Ù ÙƒÙ„Ù…Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† ØµÙØ­Ø© Ù…Ø­Ø±Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª.</div>';
        selectedCountEl.textContent = '0';
        return;
      }
      
      let selectedCount = 0;
      
      words.forEach((word, index) => {
        const isSelected = selectedWords.some(w => 
          w.german === word.german && w.english === word.english
        );
        
        if (isSelected) selectedCount++;
        
        const item = document.createElement('div');
        item.className = `word-selection-item ${isSelected ? 'selected' : ''}`;
        item.innerHTML = `
          <input type="checkbox" ${isSelected ? 'checked' : ''} data-index="${index}" />
          <div class="word-selection-text">
            <div class="word-selection-german">${escapeHtml(word.german)}</div>
            <div class="word-selection-english">${escapeHtml(word.english)}</div>
          </div>
        `;
        
        item.addEventListener('click', (e) => {
          if (e.target.type !== 'checkbox') {
            const checkbox = item.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            updateSelection(checkbox);
          }
        });
        
        const checkbox = item.querySelector('input[type="checkbox"]');
        checkbox.addEventListener('change', (e) => updateSelection(e.target));
        
        wordSelectionList.appendChild(item);
      });
      
      selectedCountEl.textContent = selectedCount;
    }

    function updateSelection(checkbox) {
      const index = parseInt(checkbox.dataset.index);
      const word = words[index];
      const isChecked = checkbox.checked;
      
      if (isChecked) {
        // Add to selected words if not already there
        if (!selectedWords.some(w => w.german === word.german && w.english === word.english)) {
          selectedWords.push({...word});
        }
      } else {
        // Remove from selected words
        selectedWords = selectedWords.filter(w => 
          !(w.german === word.german && w.english === word.english)
        );
      }
      
      // Update UI
      checkbox.parentElement.classList.toggle('selected', isChecked);
      selectedCountEl.textContent = selectedWords.length;
      saveSelectedWords();
    }

    function closeWordSelectionModal() {
      wordSelectionModal.classList.add('hidden');
      currentExerciseType = null;
    }

    function confirmWordSelection() {
      if (selectedWords.length < 2) {
        alert(`ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ø®ØªÙŠØ§Ø± ${2 - selectedWords.length} ÙƒÙ„Ù…Ø§Øª Ø£Ø®Ø±Ù‰ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¨Ø¯Ø¡`);
        return;
      }
      
      closeWordSelectionModal();
      
      // Start the appropriate exercise
      switch (currentExerciseType) {
        case 'quiz':
          startQuizWithSelectedWords();
          break;
        case 'writing':
          startWritingWithSelectedWords();
          break;
        case 'memory':
          startMemoryWithSelectedWords();
          break;
      }
    }

    // ===== MISTAKES REVIEW FUNCTIONS - UPDATED =====
    startMistakesReviewBtn.addEventListener('click', startMistakesReview);
    stopMistakesReviewBtn.addEventListener('click', stopMistakesReview);
    checkMistakeAnswerBtn.addEventListener('click', checkMistakeAnswer);
    nextMistakeBtn.addEventListener('click', nextMistakeReview);
    mistakeReviewInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && mistakesReviewActive) {
        checkMistakeAnswer();
      }
    });

    function startMistakesReview() {
      if (mistakes.length === 0) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©!');
        return;
      }
      
      mistakesReviewActive = true;
      currentMistakeIndex = 0;
      
      // Get uncorrected mistakes first, then corrected ones
      const uncorrectedMistakes = mistakes.filter(m => m.correctedCount < m.needsCorrectCount);
      const correctedMistakes = mistakes.filter(m => m.correctedCount >= m.needsCorrectCount);
      
      mistakesReviewQueue = shuffle([...uncorrectedMistakes, ...correctedMistakes]);
      
      if (mistakesReviewQueue.length === 0) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©!');
        return;
      }
      
      // Hide mistakes list
      mistakesListContainer.style.display = 'none';
      startMistakesReviewBtn.style.display = 'none';
      clearCorrectedMistakesBtn.style.display = 'none';
      clearAllMistakesBtn.style.display = 'none';
      stopMistakesReviewBtn.style.display = 'inline-block';
      
      // Show exercise
      mistakeReviewExercise.classList.add('active');
      loadMistakeForReview();
    }

    function stopMistakesReview() {
      mistakesReviewActive = false;
      
      // Show mistakes list
      mistakesListContainer.style.display = 'block';
      startMistakesReviewBtn.style.display = 'inline-block';
      clearCorrectedMistakesBtn.style.display = 'inline-block';
      clearAllMistakesBtn.style.display = 'inline-block';
      stopMistakesReviewBtn.style.display = 'none';
      
      // Hide exercise
      mistakeReviewExercise.classList.remove('active');
      
      // Reset UI
      mistakeReviewOptions.innerHTML = '';
      mistakeReviewInputContainer.style.display = 'none';
      mistakeReviewFeedback.textContent = '';
      mistakeReviewFeedback.className = 'mistake-review-feedback';
      mistakeReviewNext.style.display = 'none';
    }

    function loadMistakeForReview() {
      if (currentMistakeIndex >= mistakesReviewQueue.length) {
        // Review completed
        mistakeReviewQuestion.innerHTML = `
          <div style="text-align:center">
            <div style="font-size:48px">ğŸ‰</div>
            <div style="font-size:24px;color:#ffcccc;margin:10px 0">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©!</div>
            <div style="font-size:18px;color:var(--muted)">Ù„Ù‚Ø¯ Ø±Ø§Ø¬Ø¹Øª ${mistakesReviewQueue.length} Ø®Ø·Ø£</div>
          </div>
        `;
        
        mistakeReviewOptions.innerHTML = '';
        mistakeReviewInputContainer.style.display = 'none';
        mistakeReviewFeedback.textContent = '';
        mistakeReviewNext.style.display = 'none';
        
        // Update stats
        updateMistakesStats();
        
        return;
      }
      
      currentMistakeReview = mistakesReviewQueue[currentMistakeIndex];
      
      // Update progress display
      currentMistakeProgress.textContent = currentMistakeIndex + 1;
      totalMistakesToReview.textContent = mistakesReviewQueue.length;
      currentCorrectedCount.textContent = currentMistakeReview.correctedCount;
      needsCorrectCount.textContent = currentMistakeReview.needsCorrectCount;
      
      // Clear previous state
      mistakeReviewOptions.innerHTML = '';
      mistakeReviewInputContainer.style.display = 'none';
      mistakeReviewFeedback.textContent = '';
      mistakeReviewFeedback.className = 'mistake-review-feedback';
      mistakeReviewNext.style.display = 'none';
      mistakeReviewInput.value = '';
      
      if (currentMistakeReview.type === 'quiz') {
        // Show quiz-type mistake
        mistakeReviewQuestion.innerHTML = `Ù…Ø§ Ù‡ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© Ù„Ù€:<br><strong style="color:#ffcccc;font-size:24px;margin-top:10px;display:block">${escapeHtml(currentMistakeReview.question)}</strong>`;
        
        // Create options
        const numOpts = Math.max(2, Math.min(6, parseInt(optsCount.value) || 4));
        const quizWords = selectedWords.length > 0 ? selectedWords : words.slice(-parseInt(exerciseLimit.value) || 20);
        const choices = buildChoices(currentMistakeReview.correct, numOpts, quizWords);
        
        choices.forEach(c => {
          const opt = document.createElement('div');
          opt.className = 'mistake-review-option';
          opt.textContent = c;
          opt.onclick = () => handleMistakeReviewAnswer(c, opt);
          mistakeReviewOptions.appendChild(opt);
        });
        
        mistakeReviewOptions.style.display = 'grid';
        
      } else if (currentMistakeReview.type === 'writing') {
        // Show writing-type mistake
        mistakeReviewQuestion.innerHTML = `Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© Ù„Ù€:<br><strong style="color:#ffcccc;font-size:28px;margin-top:10px;display:block">${escapeHtml(currentMistakeReview.question)}</strong>`;
        
        mistakeReviewInputContainer.style.display = 'block';
        mistakeReviewInput.focus();
      }
      
      // Pronounce if enabled
      if (document.getElementById('usePron').checked && currentMistakeReview.type === 'writing') {
        setTimeout(() => pronounce(currentMistakeReview.correct), 500);
      }
    }

    function handleMistakeReviewAnswer(choice, el) {
      if (el.classList.contains('correct') || el.classList.contains('wrong')) return;
      
      const allOptions = document.querySelectorAll('.mistake-review-option');
      
      if (choice === currentMistakeReview.correct) {
        // Correct answer
        el.classList.add('correct');
        
        // Update mistake progress
        currentMistakeReview.correctedCount++;
        currentMistakeReview.lastAttempt = 'correct';
        
        mistakeReviewFeedback.innerHTML = `
          <div style="font-size:24px">âœ… ØµØ­ÙŠØ­!</div>
          <div style="margin-top:10px;font-size:18px">"${escapeHtml(currentMistakeReview.correct)}" Ù‡ÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</div>
        `;
        mistakeReviewFeedback.className = 'mistake-review-feedback correct';
        
      } else {
        // Wrong answer
        el.classList.add('wrong');
        
        // Update mistake
        currentMistakeReview.lastAttempt = 'wrong';
        
        // Highlight correct answer
        allOptions.forEach(opt => {
          if (opt.textContent === currentMistakeReview.correct) {
            opt.classList.add('correct');
          }
          opt.style.pointerEvents = 'none';
        });
        
        mistakeReviewFeedback.innerHTML = `
          <div style="font-size:24px">âŒ ØºÙŠØ± ØµØ­ÙŠØ­</div>
          <div style="margin-top:10px;font-size:16px">Ø¥Ø¬Ø§Ø¨ØªÙƒ: "${escapeHtml(choice)}"</div>
          <div style="margin-top:10px;font-size:16px;color:#19b56b">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: "${escapeHtml(currentMistakeReview.correct)}"</div>
        `;
        mistakeReviewFeedback.className = 'mistake-review-feedback incorrect';
      }
      
      // Save the updated mistake
      saveMistakes();
      
      // Show next button after delay
      setTimeout(() => {
        mistakeReviewNext.style.display = 'block';
      }, 1000);
    }

    function checkMistakeAnswer() {
      if (!currentMistakeReview || !mistakesReviewActive) return;
      
      const userAnswer = mistakeReviewInput.value.trim();
      if (!userAnswer) {
        mistakeReviewFeedback.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¥Ø¬Ø§Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹';
        mistakeReviewFeedback.className = 'mistake-review-feedback incorrect';
        return;
      }
      
      const correctAnswer = currentMistakeReview.correct;
      const normalizedUserAnswer = normalizeText(userAnswer);
      const normalizedCorrectAnswer = normalizeText(correctAnswer);
      
      // Check if answer is correct
      let isCorrect = false;
      if (spellingTolerance.checked) {
        isCorrect = normalizedUserAnswer === normalizedCorrectAnswer ||
                   Math.abs(normalizedUserAnswer.length - normalizedCorrectAnswer.length) <= 2;
        
        if (!isCorrect) {
          const distance = levenshteinDistance(normalizedUserAnswer, normalizedCorrectAnswer);
          isCorrect = distance <= 1;
        }
      } else {
        isCorrect = normalizedUserAnswer === normalizedCorrectAnswer;
      }
      
      if (isCorrect) {
        // Correct answer
        currentMistakeReview.correctedCount++;
        currentMistakeReview.lastAttempt = 'correct';
        
        mistakeReviewFeedback.innerHTML = `
          <div style="font-size:24px">âœ… ØµØ­ÙŠØ­!</div>
          <div style="margin-top:10px;font-size:18px">"${escapeHtml(correctAnswer)}" Ù‡ÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</div>
        `;
        mistakeReviewFeedback.className = 'mistake-review-feedback correct';
        
      } else {
        // Wrong answer
        currentMistakeReview.lastAttempt = 'wrong';
        
        mistakeReviewFeedback.innerHTML = `
          <div style="font-size:24px">âŒ ØºÙŠØ± ØµØ­ÙŠØ­</div>
          <div style="margin-top:10px;font-size:16px">Ø¥Ø¬Ø§Ø¨ØªÙƒ: "${escapeHtml(userAnswer)}"</div>
          <div style="margin-top:10px;font-size:16px;color:#19b56b">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: "${escapeHtml(correctAnswer)}"</div>
        `;
        mistakeReviewFeedback.className = 'mistake-review-feedback incorrect';
      }
      
      // Save the updated mistake
      saveMistakes();
      
      // Update progress display
      currentCorrectedCount.textContent = currentMistakeReview.correctedCount;
      
      // Show next button after delay
      setTimeout(() => {
        mistakeReviewNext.style.display = 'block';
      }, 1000);
    }

    function nextMistakeReview() {
      currentMistakeIndex++;
      loadMistakeForReview();
    }

    clearCorrectedMistakesBtn.addEventListener('click', () => {
      if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…ØµØ­Ø­Ø©ØŸ')) {
        mistakes = mistakes.filter(m => m.correctedCount < m.needsCorrectCount);
        saveMistakes();
        if (mistakesReviewActive) {
          stopMistakesReview();
        }
      }
    });
    
    clearAllMistakesBtn.addEventListener('click', () => {
      if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ØŸ Ø³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.')) {
        mistakes = [];
        saveMistakes();
        if (mistakesReviewActive) {
          stopMistakesReview();
        }
      }
    });

    // ===== WORD SELECTION EVENT HANDLERS =====
    selectAllBtn.addEventListener('click', () => {
      selectedWords = [...words];
      saveSelectedWords();
      renderWordSelectionList();
    });
    
    deselectAllBtn.addEventListener('click', () => {
      selectedWords = [];
      saveSelectedWords();
      renderWordSelectionList();
    });
    
    selectLastBtn.addEventListener('click', () => {
      const limit = parseInt(exerciseLimit.value) || 20;
      const lastWords = words.slice(-limit);
      selectedWords = [...lastWords];
      saveSelectedWords();
      renderWordSelectionList();
    });
    
    selectRandomBtn.addEventListener('click', () => {
      const limit = parseInt(exerciseLimit.value) || 20;
      const shuffled = shuffle([...words]);
      selectedWords = shuffled.slice(0, Math.min(limit, shuffled.length));
      saveSelectedWords();
      renderWordSelectionList();
    });
    
    cancelSelectionBtn.addEventListener('click', closeWordSelectionModal);
    confirmSelectionBtn.addEventListener('click', confirmWordSelection);
    closeModalBtn.addEventListener('click', closeWordSelectionModal);
    
    // Close modal when clicking outside
    wordSelectionModal.addEventListener('click', (e) => {
      if (e.target === wordSelectionModal) {
        closeWordSelectionModal();
      }
    });

    // Navigation
    navBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const pageId = btn.dataset.page;
        
        // Update active nav button
        navBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Show selected page
        pages.forEach(page => page.classList.remove('active'));
        document.getElementById(`${pageId}-page`).classList.add('active');
        
        // Reset exercise states when leaving
        if (pageId !== 'quiz' && quizActive) {
          endQuiz();
        }
        if (pageId !== 'writing' && writingActive) {
          endWriting();
        }
        if (pageId !== 'memory' && memoryActive) {
          stopMemoryGame();
        }
        if (pageId !== 'mistakes' && mistakesReviewActive) {
          stopMistakesReview();
        }
        
        // Update mistakes page if needed
        if (pageId === 'mistakes') {
          updateMistakesStats();
          renderMistakesList();
          // Ensure list is visible
          mistakesListContainer.style.display = 'block';
          startMistakesReviewBtn.style.display = 'inline-block';
          clearCorrectedMistakesBtn.style.display = 'inline-block';
          clearAllMistakesBtn.style.display = 'inline-block';
          stopMistakesReviewBtn.style.display = 'none';
          mistakeReviewExercise.classList.remove('active');
        }
      });
    });

    // Exercise selection
    exerciseBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const exercise = btn.dataset.exercise;
        document.querySelector(`[data-page="${exercise}"]`).click();
      });
    });

    // Word selection buttons
    selectWordsQuizBtn.addEventListener('click', () => openWordSelectionModal('quiz'));
    selectWordsWritingBtn.addEventListener('click', () => openWordSelectionModal('writing'));
    selectWordsMemoryBtn.addEventListener('click', () => openWordSelectionModal('memory'));

    // Back to exercises
    backToExercisesQuizBtn.addEventListener('click', () => {
      document.querySelector('[data-page="exercises"]').click();
    });

    backToExercisesWritingBtn.addEventListener('click', () => {
      document.querySelector('[data-page="exercises"]').click();
    });

    backToExercisesMemoryBtn.addEventListener('click', () => {
      document.querySelector('[data-page="exercises"]').click();
    });

    // ===== EDITOR FUNCTIONS =====
    
    function persist(){ localStorage.setItem(WORDS_KEY, JSON.stringify(words)); }
    
    function renderList(){
      listEl.innerHTML='';
      words.forEach((w,i)=>{
        const item = document.createElement('div');
        item.className='word-item';
        item.innerHTML = `
          <div class="word-content">
            <div class="word-text">${escapeHtml(w.german)}</div>
            <div class="word-meaning">${escapeHtml(w.english)}</div>
          </div>
          <div class="word-actions">
            <button class="small ghost" onclick="pronounce('${escapeHtml(w.german)}')" title="Ù†Ø·Ù‚">ğŸ”Š</button>
            <button class="small ghost" onclick="selectWord(${i})" title="ØªØ­Ø¯ÙŠØ¯">ğŸ“</button>
            <button class="small ghost" onclick="deleteWord(${i})" title="Ø­Ø°Ù" style="color:#ff9999">ğŸ—‘ï¸</button>
          </div>
        `;
        listEl.appendChild(item);
      });
      wordCountEl.textContent = words.length;
    }

    function escapeHtml(s){ 
      if (!s) return '';
      return s.toString().replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"
      })[c]); 
    }

    // Word functions
    window.selectWord = function(i){
      if (words[i]) {
        germanInput.value = words[i].german;
        englishInput.value = words[i].english;
      }
    };

    window.deleteWord = function(i){
      if(confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø©ØŸ')){
        words.splice(i,1);
        persist();
        renderList();
      }
    };

    // Add word
    addBtn.addEventListener('click', ()=>{
      const g = germanInput.value.trim();
      const e = englishInput.value.trim();
      if(!g || !e){ alert('ÙŠØ¬Ø¨ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚Ù„ÙŠÙ†'); return; }
      words.push({german:g, english:e}); 
      persist(); 
      renderList(); 
      germanInput.value=''; 
      englishInput.value='';
      germanInput.focus();
    });

    // Pronunciation
    pronBtn.addEventListener('click', ()=>{ 
      const text = germanInput.value.trim();
      if (text) pronounce(text); 
    });

    function pronounce(text){
      if(!text) return; 
      if('speechSynthesis' in window){ 
        const ut = new SpeechSynthesisUtterance(text);
        ut.lang = 'de-DE'; 
        ut.rate = 0.9;
        window.speechSynthesis.cancel(); 
        window.speechSynthesis.speak(ut);
      } else {
        alert('Ù…ÙŠØ²Ø© Ø§Ù„Ù†Ø·Ù‚ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­');
      }
    }

    // Clear inputs
    clearInputsBtn.addEventListener('click', ()=>{
      germanInput.value = '';
      englishInput.value = '';
      germanInput.focus();
    });

    // Clear all words
    clearAllBtn.addEventListener('click', ()=>{
      if(words.length === 0) return;
      if(confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„Ù…Ø§Øª (${words.length} ÙƒÙ„Ù…Ø©)?`)){
        words=[];
        selectedWords = [];
        persist();
        saveSelectedWords();
        renderList();
      }
    });

    // Shuffle words
    shuffleWordsBtn.addEventListener('click', ()=>{
      words = shuffle([...words]);
      persist();
      renderList();
    });

    // Save/load
    saveBtn.addEventListener('click', ()=>{
      const data = JSON.stringify(words, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'german_words.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    loadBtn.addEventListener('click', ()=> fileInput.click());
    
    fileInput.addEventListener('change', ()=>{
      const f = fileInput.files[0]; 
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{ 
          const data = JSON.parse(reader.result); 
          if(Array.isArray(data)){
            words = data.filter(item => item.german && item.english && 
                     typeof item.german === 'string' && 
                     typeof item.english === 'string');
            persist(); 
            renderList(); 
            alert(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${words.length} ÙƒÙ„Ù…Ø©`);
          } else {
            alert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ù„Ù JSON Ù…ØµÙÙˆÙØ©');
          }
        } catch(e){ 
          alert('Ù…Ù„Ù JSON ØºÙŠØ± ØµØ§Ù„Ø­');
        }
        fileInput.value = '';
      };
      reader.readAsText(f);
    });

    csvBtn.addEventListener('click', ()=>{
      if(words.length === 0){
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§');
        return;
      }
      let out = 'german,english\n';
      words.forEach(w => { 
        out += `"${w.german.replace(/"/g,'""')}","${w.english.replace(/"/g,'""')}"\n`; 
      });
      const blob = new Blob([out], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'german_words.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // ===== QUIZ FUNCTIONS =====
    function updateQuizStats() {
      quizRemainingEl.textContent = quizQueue.length;
      const accuracy = quizAttempts > 0 ? Math.round((quizCorrect / quizAttempts) * 100) : 0;
      quizAccuracyEl.textContent = `${accuracy}%`;
      quizScoreEl.textContent = `${quizCorrect}/${quizAttempts}`;
    }

    startQuizBtn.addEventListener('click', () => {
      if (selectedWords.length > 0) {
        startQuizWithSelectedWords();
      } else {
        startQuiz();
      }
    });
    
    nextQuizBtn.addEventListener('click', nextQuizQuestion);
    endQuizBtn.addEventListener('click', endQuiz);

    function startQuiz() {
      if(words.length < 2){ 
        alert('Ø£Ø¶Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙƒÙ„Ù…ØªÙŠÙ† Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        document.querySelector('[data-page="editor"]').click();
        return; 
      }
      
      quizActive = true;
      quizCorrect = 0; 
      quizAttempts = 0; 
      quizMistakes = [];
      
      const limit = parseInt(exerciseLimit.value) || 20;
      const quizWords = words.slice(-limit);
      
      if(quizWords.length < 2){
        alert(`ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ${2 - quizWords.length} ÙƒÙ„Ù…Ø§Øª Ø£Ø®Ø±Ù‰ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±`);
        return;
      }
      
      quizQueue = shuffle([...quizWords]);
      
      // Update UI
      startQuizBtn.style.display = 'none';
      selectWordsQuizBtn.style.display = 'none';
      nextQuizBtn.style.display = 'inline-block';
      endQuizBtn.style.display = 'inline-block';
      quizMistakesContainer.style.display = 'none';
      
      nextQuizQuestion();
    }

    function startQuizWithSelectedWords() {
      if(selectedWords.length < 2){ 
        alert('Ø§Ø®ØªØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙƒÙ„Ù…ØªÙŠÙ† Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        openWordSelectionModal('quiz');
        return; 
      }
      
      quizActive = true;
      quizCorrect = 0; 
      quizAttempts = 0; 
      quizMistakes = [];
      
      quizQueue = shuffle([...selectedWords]);
      
      // Update UI
      startQuizBtn.style.display = 'none';
      selectWordsQuizBtn.style.display = 'none';
      nextQuizBtn.style.display = 'inline-block';
      endQuizBtn.style.display = 'inline-block';
      quizMistakesContainer.style.display = 'none';
      
      nextQuizQuestion();
    }

    function nextQuizQuestion() {
      if(quizQueue.length === 0){ 
        endQuiz();
        return; 
      }
      
      currentQuizWord = quizQueue.pop();
      quizPromptEl.innerHTML = `Ù…Ø§ Ù‡ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© Ù„Ù€:<br><strong style="color:#ffcccc;font-size:24px;margin-top:10px;display:block">${escapeHtml(currentQuizWord.english)}</strong>`;
      
      const numOpts = Math.max(2, Math.min(6, parseInt(optsCount.value) || 4));
      const quizWords = selectedWords.length > 0 ? selectedWords : words.slice(-parseInt(exerciseLimit.value) || 20);
      const choices = buildChoices(currentQuizWord.german, numOpts, quizWords);
      renderQuizOptions(choices);
      
      if(document.getElementById('usePron').checked) {
        setTimeout(() => pronounce(currentQuizWord.german), 300);
      }
      
      updateQuizStats();
    }

    function buildChoices(correctGerman, num, wordPool){
      const pool = wordPool.map(w => w.german).filter(g => g !== correctGerman);
      const choices = [correctGerman];
      
      while(choices.length < num && pool.length){
        const i = Math.floor(Math.random() * pool.length); 
        choices.push(pool.splice(i,1)[0]);
      }
      
      while(choices.length < num) choices.push(correctGerman);
      return shuffle(choices);
    }

    function renderQuizOptions(choices){
      quizOptsEl.innerHTML='';
      choices.forEach(c => {
        const opt = document.createElement('div');
        opt.className = 'quiz-option';
        opt.textContent = c;
        opt.onclick = () => quizAnswer(c, opt);
        quizOptsEl.appendChild(opt);
      });
    }

    function quizAnswer(choice, el){
      if(el.classList.contains('correct') || el.classList.contains('wrong')) return;
      
      quizAttempts++; 
      const allOptions = document.querySelectorAll('.quiz-option');
      
      if(choice === currentQuizWord.german){
        quizCorrect++; 
        el.classList.add('correct');
        setTimeout(() => { 
          allOptions.forEach(opt => opt.style.pointerEvents = 'none');
          setTimeout(nextQuizQuestion, 800);
        }, 300);
      } else { 
        el.classList.add('wrong');
        
        // Record mistake
        addMistake('quiz', currentQuizWord.english, currentQuizWord.german, choice);
        quizMistakes.push({
          question: currentQuizWord.english,
          correct: currentQuizWord.german,
          wrong: choice
        });
        
        // Highlight correct answer
        allOptions.forEach(opt => {
          if(opt.textContent === currentQuizWord.german) {
            opt.classList.add('correct');
          }
          opt.style.pointerEvents = 'none';
        });
        
        setTimeout(nextQuizQuestion, 1200);
      } 
      
      updateQuizStats();
    }

    function endQuiz() {
      quizActive = false;
      
      quizPromptEl.innerHTML = `
        <div style="text-align:center">
          <div style="font-size:48px">${quizCorrect === quizAttempts ? 'ğŸ‰' : 'ğŸ“Š'}</div>
          <div style="font-size:24px;color:#ffcccc;margin:10px 0">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù†ØªÙ‡Ù‰!</div>
          <div style="font-size:18px;color:var(--muted)">${quizCorrect} Ù…Ù† ${quizAttempts} Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©</div>
          <div style="font-size:16px;color:#19b56b;margin-top:10px">Ø§Ù„Ø¯Ù‚Ø©: ${quizAttempts > 0 ? Math.round((quizCorrect / quizAttempts) * 100) : 0}%</div>
        </div>
      `;
      
      quizOptsEl.innerHTML = '';
      
      startQuizBtn.style.display = 'inline-block';
      selectWordsQuizBtn.style.display = 'inline-block';
      nextQuizBtn.style.display = 'none';
      endQuizBtn.style.display = 'none';
      
      // Show mistakes if any
      if(quizMistakes.length > 0) {
        quizMistakesContainer.style.display = 'block';
        quizMistakesCount.textContent = quizMistakes.length;
        
        let mistakesHtml = '';
        quizMistakes.forEach((m, i) => {
          mistakesHtml += `
            <div class="mistake-item">
              <div class="mistake-question">${i+1}. ${escapeHtml(m.question)}</div>
              <div class="mistake-answer">
                <span class="correct-answer">âœ… ${escapeHtml(m.correct)}</span>
                <span class="wrong-answer">âŒ ${escapeHtml(m.wrong)}</span>
              </div>
            </div>
          `;
        });
        
        quizMistakesList.innerHTML = mistakesHtml;
      }
      
      updateQuizStats();
    }

    // ===== WRITING EXERCISE FUNCTIONS =====
    function updateWritingStats() {
      writingRemainingEl.textContent = writingQueue.length;
      const accuracy = writingAttempts > 0 ? Math.round((writingCorrect / writingAttempts) * 100) : 0;
      writingAccuracyEl.textContent = `${accuracy}%`;
      writingScoreEl.textContent = `${writingCorrect}/${writingAttempts}`;
    }

    startWritingBtn.addEventListener('click', () => {
      if (selectedWords.length > 0) {
        startWritingWithSelectedWords();
      } else {
        startWriting();
      }
    });
    
    checkAnswerBtn.addEventListener('click', checkWritingAnswer);
    nextWritingBtn.addEventListener('click', nextWritingQuestion);
    showAnswerBtn.addEventListener('click', showWritingAnswer);
    endWritingBtn.addEventListener('click', endWriting);
    writingInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && writingActive && !writingInput.disabled) {
        checkWritingAnswer();
      }
    });

    function startWriting() {
      if(words.length < 2){ 
        alert('Ø£Ø¶Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙƒÙ„Ù…ØªÙŠÙ† Ù„Ø¨Ø¯Ø¡ ØªÙ…Ø±ÙŠÙ† Ø§Ù„ÙƒØªØ§Ø¨Ø©');
        document.querySelector('[data-page="editor"]').click();
        return; 
      }
      
      writingActive = true;
      writingCorrect = 0; 
      writingAttempts = 0; 
      writingMistakes = [];
      
      const limit = parseInt(exerciseLimit.value) || 20;
      const writingWords = words.slice(-limit);
      
      if(writingWords.length < 2){
        alert(`ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ${2 - writingWords.length} ÙƒÙ„Ù…Ø§Øª Ø£Ø®Ø±Ù‰ Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ…Ø±ÙŠÙ†`);
        return;
      }
      
      writingQueue = shuffle([...writingWords]);
      
      // Update UI
      startWritingBtn.style.display = 'none';
      selectWordsWritingBtn.style.display = 'none';
      checkAnswerBtn.style.display = 'inline-block';
      nextWritingBtn.style.display = 'none';
      showAnswerBtn.style.display = 'inline-block';
      endWritingBtn.style.display = 'inline-block';
      writingMistakesContainer.style.display = 'none';
      writingInput.disabled = false;
      writingInput.focus();
      
      nextWritingQuestion();
    }

    function startWritingWithSelectedWords() {
      if(selectedWords.length < 2){ 
        alert('Ø§Ø®ØªØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙƒÙ„Ù…ØªÙŠÙ† Ù„Ø¨Ø¯Ø¡ ØªÙ…Ø±ÙŠÙ† Ø§Ù„ÙƒØªØ§Ø¨Ø©');
        openWordSelectionModal('writing');
        return; 
      }
      
      writingActive = true;
      writingCorrect = 0; 
      writingAttempts = 0; 
      writingMistakes = [];
      
      writingQueue = shuffle([...selectedWords]);
      
      // Update UI
      startWritingBtn.style.display = 'none';
      selectWordsWritingBtn.style.display = 'none';
      checkAnswerBtn.style.display = 'inline-block';
      nextWritingBtn.style.display = 'none';
      showAnswerBtn.style.display = 'inline-block';
      endWritingBtn.style.display = 'inline-block';
      writingMistakesContainer.style.display = 'none';
      writingInput.disabled = false;
      writingInput.focus();
      
      nextWritingQuestion();
    }

    function nextWritingQuestion() {
      if(writingQueue.length === 0){ 
        endWriting();
        return; 
      }
      
      currentWritingWord = writingQueue.pop();
      writingPromptEl.innerHTML = `Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© Ù„Ù€:<br><strong style="color:#ffcccc;font-size:28px;margin-top:10px;display:block">${escapeHtml(currentWritingWord.english)}</strong>`;
      writingHintEl.textContent = 'Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø£Ø¯Ù†Ø§Ù‡ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ­Ù‚Ù‚" Ø£Ùˆ Ø§Ø¶ØºØ· Enter';
      
      writingInput.value = '';
      writingFeedback.textContent = '';
      writingFeedback.className = 'writing-feedback';
      writingInput.disabled = false;
      writingInput.focus();
      
      checkAnswerBtn.style.display = 'inline-block';
      nextWritingBtn.style.display = 'none';
      showAnswerBtn.style.display = 'inline-block';
      
      if(document.getElementById('usePron').checked) {
        setTimeout(() => pronounce(currentWritingWord.german), 500);
      }
      
      updateWritingStats();
    }

    function normalizeText(text) {
      return text.toLowerCase().trim()
        .replace(/\s+/g, ' ')
        .replace(/Ã¤/g, 'ae')
        .replace(/Ã¶/g, 'oe')
        .replace(/Ã¼/g, 'ue')
        .replace(/ÃŸ/g, 'ss');
    }

    function checkWritingAnswer() {
      if (!currentWritingWord || !writingActive) return;
      
      const userAnswer = writingInput.value.trim();
      if (!userAnswer) {
        writingFeedback.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¥Ø¬Ø§Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹';
        writingFeedback.className = 'writing-feedback incorrect';
        return;
      }
      
      writingAttempts++;
      writingInput.disabled = true;
      
      const correctAnswer = currentWritingWord.german;
      const normalizedUserAnswer = normalizeText(userAnswer);
      const normalizedCorrectAnswer = normalizeText(correctAnswer);
      
      // Check if answer is correct (with spelling tolerance if enabled)
      let isCorrect = false;
      if (spellingTolerance.checked) {
        isCorrect = normalizedUserAnswer === normalizedCorrectAnswer ||
                   Math.abs(normalizedUserAnswer.length - normalizedCorrectAnswer.length) <= 2;
        
        if (!isCorrect) {
          const distance = levenshteinDistance(normalizedUserAnswer, normalizedCorrectAnswer);
          isCorrect = distance <= 1;
        }
      } else {
        isCorrect = normalizedUserAnswer === normalizedCorrectAnswer;
      }
      
      if (isCorrect) {
        writingCorrect++;
        writingFeedback.innerHTML = `
          <div style="font-size:24px">âœ… ØµØ­ÙŠØ­!</div>
          <div style="margin-top:10px;font-size:18px">"${escapeHtml(correctAnswer)}" Ù‡ÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</div>
        `;
        writingFeedback.className = 'writing-feedback correct';
        
        // Auto proceed to next question after delay
        setTimeout(() => {
          if (writingQueue.length > 0) {
            nextWritingQuestion();
          } else {
            endWriting();
          }
        }, 1500);
      } else {
        writingFeedback.innerHTML = `
          <div style="font-size:24px">âŒ ØºÙŠØ± ØµØ­ÙŠØ­</div>
          <div style="margin-top:10px;font-size:16px">Ø¥Ø¬Ø§Ø¨ØªÙƒ: "${escapeHtml(userAnswer)}"</div>
        `;
        writingFeedback.className = 'writing-feedback incorrect';
        
        // Record mistake
        addMistake('writing', currentWritingWord.english, currentWritingWord.german, userAnswer);
        writingMistakes.push({
          question: currentWritingWord.english,
          correct: currentWritingWord.german,
          wrong: userAnswer
        });
        
        checkAnswerBtn.style.display = 'none';
        nextWritingBtn.style.display = 'inline-block';
        
        // Auto show answer if enabled
        if (autoShowAnswer.checked) {
          setTimeout(showWritingAnswer, 1000);
        }
      }
      
      updateWritingStats();
    }

    function showWritingAnswer() {
      if (!currentWritingWord) return;
      
      writingFeedback.innerHTML = `
        <div style="font-size:20px">ğŸ‘ï¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</div>
        <div class="writing-answer">${escapeHtml(currentWritingWord.german)}</div>
        <div style="margin-top:10px;font-size:14px;color:#ffcccc">Ù…Ø¹Ù†Ù‰: ${escapeHtml(currentWritingWord.english)}</div>
      `;
      writingFeedback.className = 'writing-feedback show-answer';
      
      // Pronounce the correct answer
      if (document.getElementById('usePron').checked) {
        pronounce(currentWritingWord.german);
      }
    }

    function endWriting() {
      writingActive = false;
      
      writingPromptEl.innerHTML = `
        <div style="text-align:center">
          <div style="font-size:48px">${writingCorrect === writingAttempts ? 'ğŸ‰' : 'ğŸ“Š'}</div>
          <div style="font-size:24px;color:#ffcccc;margin:10px 0">ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† ØªÙ…Ø±ÙŠÙ† Ø§Ù„ÙƒØªØ§Ø¨Ø©!</div>
          <div style="font-size:18px;color:var(--muted)">${writingCorrect} Ù…Ù† ${writingAttempts} Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©</div>
          <div style="font-size:16px;color:#19b56b;margin-top:10px">Ø§Ù„Ø¯Ù‚Ø©: ${writingAttempts > 0 ? Math.round((writingCorrect / writingAttempts) * 100) : 0}%</div>
        </div>
      `;
      
      writingHintEl.textContent = 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ…Ø±ÙŠÙ†" Ù„Ø¨Ø¯Ø¡ ØªÙ…Ø±ÙŠÙ† ÙƒØªØ§Ø¨Ø© Ø¬Ø¯ÙŠØ¯';
      writingInput.value = '';
      writingInput.disabled = true;
      writingFeedback.textContent = '';
      writingFeedback.className = 'writing-feedback';
      
      startWritingBtn.style.display = 'inline-block';
      selectWordsWritingBtn.style.display = 'inline-block';
      checkAnswerBtn.style.display = 'none';
      nextWritingBtn.style.display = 'none';
      showAnswerBtn.style.display = 'none';
      endWritingBtn.style.display = 'none';
      
      // Show mistakes if any
      if(writingMistakes.length > 0) {
        writingMistakesContainer.style.display = 'block';
        writingMistakesCount.textContent = writingMistakes.length;
        
        let mistakesHtml = '';
        writingMistakes.forEach((m, i) => {
          mistakesHtml += `
            <div class="mistake-item">
              <div class="mistake-question">${i+1}. ${escapeHtml(m.question)}</div>
              <div class="mistake-answer">
                <span class="correct-answer">âœ… ${escapeHtml(m.correct)}</span>
                <span class="wrong-answer">âŒ ${escapeHtml(m.wrong)}</span>
              </div>
            </div>
          `;
        });
        
        writingMistakesList.innerHTML = mistakesHtml;
      }
      
      updateWritingStats();
    }

    // ===== MEMORY GAME FUNCTIONS - FIXED FLIP ANIMATION - 16 CARDS (8 DEUTSCH + 8 ENGLISH) & HALF SIZE =====
    startMemoryBtn.addEventListener('click', () => {
      if (selectedWords.length > 0) {
        startMemoryWithSelectedWords();
      } else {
        startMemoryGame();
      }
    });
    
    restartMemoryBtn.addEventListener('click', restartMemoryGame);
    
    function startMemoryGame() {
      if(words.length < 4){ 
        alert('Ø£Ø¶Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 4 ÙƒÙ„Ù…Ø§Øª Ù„Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©');
        document.querySelector('[data-page="editor"]').click();
        return; 
      }
      
      memoryActive = true;
      memoryMoves = 0;
      memoryMatched = 0;
      memoryStartTime = Date.now();
      flippedCards = [];
      canFlip = true;
      
      // USE ONLY THE LAST 8 WORDS ADDED (8 pairs = 16 cards)
      const recentWords = words.slice(-8); // Take last 8 words
      
      if (recentWords.length < 4) {
        alert('Ø£Ø¶Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 4 ÙƒÙ„Ù…Ø§Øª Ù„Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©');
        document.querySelector('[data-page="editor"]').click();
        return;
      }
      
      // Create 16 cards (8 German + 8 English)
      memoryCards = [];
      recentWords.forEach(word => {
        // Add German card
        memoryCards.push({
          id: Date.now() + Math.random(),
          type: 'german',
          content: word.german,
          pairId: word.german + word.english,
          matched: false
        });
        
        // Add English card
        memoryCards.push({
          id: Date.now() + Math.random() + 1,
          type: 'english',
          content: word.english,
          pairId: word.german + word.english,
          matched: false
        });
      });
      
      // If we have less than 8 words, we still need 16 cards
      // So we'll duplicate some words to reach 16 cards
      while (memoryCards.length < 16 && recentWords.length > 0) {
        const word = recentWords[memoryCards.length % recentWords.length];
        
        memoryCards.push({
          id: Date.now() + Math.random() + memoryCards.length,
          type: 'german',
          content: word.german,
          pairId: word.german + word.english + '_dup' + memoryCards.length,
          matched: false
        });
        
        memoryCards.push({
          id: Date.now() + Math.random() + memoryCards.length + 1,
          type: 'english',
          content: word.english,
          pairId: word.german + word.english + '_dup' + memoryCards.length,
          matched: false
        });
      }
      
      memoryCards = shuffle(memoryCards);
      
      // Update UI
      startMemoryBtn.style.display = 'none';
      selectWordsMemoryBtn.style.display = 'none';
      restartMemoryBtn.style.display = 'inline-block';
      memoryComplete.style.display = 'none';
      renderMemoryGrid();
      startMemoryTimer();
      updateMemoryStats();
    }
    
    function startMemoryWithSelectedWords() {
      if(selectedWords.length < 4){ 
        alert('Ø§Ø®ØªØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 4 ÙƒÙ„Ù…Ø§Øª Ù„Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©');
        openWordSelectionModal('memory');
        return; 
      }
      
      memoryActive = true;
      memoryMoves = 0;
      memoryMatched = 0;
      memoryStartTime = Date.now();
      flippedCards = [];
      canFlip = true;
      
      // USE SELECTED WORDS (up to 8 for 16 cards)
      const memoryWords = selectedWords.slice(0, 8);
      
      // Create 16 cards (German + English for each word)
      memoryCards = [];
      memoryWords.forEach(word => {
        // Add German card
        memoryCards.push({
          id: Date.now() + Math.random(),
          type: 'german',
          content: word.german,
          pairId: word.german + word.english,
          matched: false
        });
        
        // Add English card
        memoryCards.push({
          id: Date.now() + Math.random() + 1,
          type: 'english',
          content: word.english,
          pairId: word.german + word.english,
          matched: false
        });
      });
      
      // If we have less than 8 words, we still need 16 cards
      // So we'll duplicate some words to reach 16 cards
      while (memoryCards.length < 16 && memoryWords.length > 0) {
        const word = memoryWords[memoryCards.length % memoryWords.length];
        
        memoryCards.push({
          id: Date.now() + Math.random() + memoryCards.length,
          type: 'german',
          content: word.german,
          pairId: word.german + word.english + '_dup' + memoryCards.length,
          matched: false
        });
        
        memoryCards.push({
          id: Date.now() + Math.random() + memoryCards.length + 1,
          type: 'english',
          content: word.english,
          pairId: word.german + word.english + '_dup' + memoryCards.length,
          matched: false
        });
      }
      
      memoryCards = shuffle(memoryCards);
      
      // Update UI
      startMemoryBtn.style.display = 'none';
      selectWordsMemoryBtn.style.display = 'none';
      restartMemoryBtn.style.display = 'inline-block';
      memoryComplete.style.display = 'none';
      renderMemoryGrid(true);
      startMemoryTimer();
      updateMemoryStats();
    }
    
    function restartMemoryGame() {
      stopMemoryGame();
      if (selectedWords.length > 0) {
        startMemoryWithSelectedWords();
      } else {
        startMemoryGame();
      }
    }
    
    function stopMemoryGame() {
      memoryActive = false;
      if (memoryTimer) {
        clearInterval(memoryTimer);
        memoryTimer = null;
      }
    }
    
    function startMemoryTimer() {
      if (memoryTimer) clearInterval(memoryTimer);
      memoryTimer = setInterval(updateMemoryTimer, 1000);
    }
    
    function updateMemoryTimer() {
      if (!memoryActive) return;
      const elapsed = Math.floor((Date.now() - memoryStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      memoryTimeEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function updateMemoryStats() {
      memoryMovesEl.textContent = memoryMoves;
      memoryMatchedEl.textContent = memoryMatched;
    }
    
    function renderMemoryGrid(usingSelectedWords = false) {
      memoryGrid.innerHTML = '';
      
      if (memoryCards.length === 0) {
        memoryGrid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„Ø¹Ø¨Ø©</div>';
        return;
      }
      
      // Display message
      const messageDiv = document.createElement('div');
      messageDiv.style.gridColumn = '1/-1';
      messageDiv.style.textAlign = 'center';
      messageDiv.style.padding = '8px';
      messageDiv.style.marginBottom = '8px';
      messageDiv.style.fontSize = '12px';
      messageDiv.style.color = '#ffcccc';
      messageDiv.style.background = 'rgba(255,11,11,0.1)';
      messageDiv.style.borderRadius = '6px';
      
      if (usingSelectedWords) {
        const wordCount = Math.min(8, selectedWords.length);
        messageDiv.innerHTML = `ğŸ¯ <strong>Ø§Ù„Ù„Ø¹Ø¨Ø© ØªØ³ØªØ®Ø¯Ù… ${wordCount} ÙƒÙ„Ù…Ø© Ù…Ø®ØªØ§Ø±Ø©</strong> (16 Ø¨Ø·Ø§Ù‚Ø©: ${wordCount} Ø£Ù„Ù…Ø§Ù†ÙŠØ© + ${wordCount} Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)`;
      } else {
        const recentWords = words.slice(-8);
        messageDiv.innerHTML = `ğŸ¯ <strong>Ø§Ù„Ù„Ø¹Ø¨Ø© ØªØ³ØªØ®Ø¯Ù… Ø¢Ø®Ø± ${Math.min(8, recentWords.length)} ÙƒÙ„Ù…Ø© Ø£Ø¶ÙØªÙ‡Ø§</strong> (16 Ø¨Ø·Ø§Ù‚Ø©: ${Math.min(8, recentWords.length)} Ø£Ù„Ù…Ø§Ù†ÙŠØ© + ${Math.min(8, recentWords.length)} Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)`;
      }
      
      memoryGrid.appendChild(messageDiv);
      
      memoryCards.forEach((card, index) => {
        const cardElement = document.createElement('div');
        cardElement.className = 'memory-card';
        if (card.matched) {
          cardElement.classList.add('matched');
        }
        
        const cardInner = document.createElement('div');
        cardInner.className = 'memory-card-inner';
        
        const cardBack = document.createElement('div');
        cardBack.className = 'card-back';
        cardBack.textContent = '?';
        
        const cardFront = document.createElement('div');
        cardFront.className = 'card-front';
        cardFront.innerHTML = `
          <div class="card-flag">${card.type === 'german' ? 'ğŸ‡©ğŸ‡ª' : 'ğŸ‡¬ğŸ‡§'}</div>
          <div class="card-text">${escapeHtml(card.content)}</div>
        `;
        
        cardInner.appendChild(cardBack);
        cardInner.appendChild(cardFront);
        cardElement.appendChild(cardInner);
        
        cardElement.addEventListener('click', () => flipMemoryCard(index, cardElement));
        memoryGrid.appendChild(cardElement);
      });
    }
    
    function flipMemoryCard(index, cardElement) {
      if (!memoryActive || !canFlip || flippedCards.includes(index) || memoryCards[index].matched) return;
      
      // Flip the card
      cardElement.classList.add('flipped');
      flippedCards.push(index);
      
      if (flippedCards.length === 2) {
        memoryMoves++;
        canFlip = false;
        updateMemoryStats();
        
        const card1 = memoryCards[flippedCards[0]];
        const card2 = memoryCards[flippedCards[1]];
        
        if (card1.pairId === card2.pairId) {
          // Match found!
          memoryCards[flippedCards[0]].matched = true;
          memoryCards[flippedCards[1]].matched = true;
          memoryMatched++;
          
          // Visual feedback for match
          setTimeout(() => {
            const card1Element = document.querySelectorAll('.memory-card')[flippedCards[0]];
            const card2Element = document.querySelectorAll('.memory-card')[flippedCards[1]];
            
            card1Element.classList.add('matched');
            card2Element.classList.add('matched');
            
            flippedCards = [];
            canFlip = true;
            updateMemoryStats();
            
            // Check if game is complete
            if (memoryMatched === 8) { // 8 pairs to match
              endMemoryGame();
            }
          }, 600);
        } else {
          // No match - flip back after delay
          setTimeout(() => {
            const card1Element = document.querySelectorAll('.memory-card')[flippedCards[0]];
            const card2Element = document.querySelectorAll('.memory-card')[flippedCards[1]];
            
            card1Element.classList.remove('flipped');
            card2Element.classList.remove('flipped');
            
            // Add shake animation for wrong match
            card1Element.classList.add('shake');
            card2Element.classList.add('shake');
            setTimeout(() => {
              card1Element.classList.remove('shake');
              card2Element.classList.remove('shake');
            }, 500);
            
            flippedCards = [];
            canFlip = true;
          }, 1000);
        }
      }
    }
    
    function endMemoryGame() {
      memoryActive = false;
      clearInterval(memoryTimer);
      
      const elapsed = Math.floor((Date.now() - memoryStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      finalMovesEl.textContent = memoryMoves;
      finalTimeEl.textContent = timeString;
      memoryComplete.style.display = 'block';
      
      // Restore selection button
      selectWordsMemoryBtn.style.display = 'inline-block';
    }

    // ===== UTILITY FUNCTIONS =====
    function levenshteinDistance(a, b) {
      const matrix = [];
      
      for (let i = 0; i <= b.length; i++) {
        matrix[i] = [i];
      }
      
      for (let j = 0; j <= a.length; j++) {
        matrix[0][j] = j;
      }
      
      for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
          if (b.charAt(i - 1) === a.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j] + 1
            );
          }
        }
      }
      
      return matrix[b.length][a.length];
    }

    function shuffle(arr){ 
      const newArr = [...arr];
      for(let i = newArr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
      }
      return newArr;
    }

    // Settings
    document.getElementById('usePron').addEventListener('change', saveSettings);
    optsCount.addEventListener('change', saveSettings);
    exerciseLimit.addEventListener('change', saveSettings);
    spellingTolerance.addEventListener('change', saveSettings);
    autoShowAnswer.addEventListener('change', saveSettings);
    mistakesToRemove.addEventListener('change', saveSettings);
    themeColor.addEventListener('change', saveSettings);

    document.getElementById('reset-settings').addEventListener('click', () => {
      if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªØŸ')){
        settings = {
          optionsCount:4, 
          usePron:true, 
          exerciseLimit:20, 
          spellingTolerance:true,
          autoShowAnswer:false,
          mistakesToRemove:2,
          themeColor:'#ff0b0b'
        };
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        initSettings();
        alert('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
      }
    });

    document.getElementById('export-data').addEventListener('click', () => {
      const allData = {
        words: words,
        settings: settings,
        mistakes: mistakes,
        selectedWords: selectedWords,
        version: '4.0',
        exportDate: new Date().toISOString()
      };
      
      const data = JSON.stringify(allData, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'german_trainer_backup.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      // Ctrl+S to save
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's'){
        e.preventDefault();
        saveBtn.click();
      }
      
      // Enter to add word (when in editor page and inputs focused)
      if(e.key === 'Enter' && document.activeElement === germanInput){
        addBtn.click();
      }
      
      // Space to pronounce (when german input focused)
      if(e.key === ' ' && document.activeElement === germanInput && germanInput.value.trim()){
        e.preventDefault();
        pronounce(germanInput.value.trim());
      }
      
      // Enter to check mistake answer
      if(e.key === 'Enter' && document.activeElement === mistakeReviewInput && mistakesReviewActive){
        checkMistakeAnswer();
      }
      
      // Escape to close modal
      if(e.key === 'Escape' && !wordSelectionModal.classList.contains('hidden')){
        closeWordSelectionModal();
      }
    });

    // Initialize
    initSettings();
    renderList();
    updateQuizStats();
    updateWritingStats();
    updateMistakesStats();
    renderMistakesList();
  </script>
</body>
</html>