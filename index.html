<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>German Trainer</title>
  <style>
    :root{
      --black:#0b0b0f;
      --dark:#1a0b0b;
      --red:#ff0b0b;
      --dark-red:#3a0606;
      --red-light:#ff3d3d;
      --green:#19b56b;
      --yellow:#ffcc00;
      --muted:#bf9a9a;
      --card:#200f0f;
    }
    *{box-sizing:border-box;font-family: 'Segoe UI', Tahoma, Arial, sans-serif}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--black),var(--dark-red));color:var(--muted)}
    .app{max-width:1100px;margin:24px auto;padding:18px;}
    .hidden{display:none !important;}

    /* Navigation */
    .nav-bar{display:flex;gap:8px;margin-bottom:20px;padding-bottom:12px;border-bottom:1px solid rgba(255,11,11,0.2);flex-wrap:wrap}
    .nav-btn{background:transparent;color:#ff9a9a;padding:6px 12px;border-radius:6px;border:1px solid rgba(255,11,11,0.3);cursor:pointer;font-weight:600;transition:all 0.3s;font-size:12px;min-width:100px;text-align:center}
    .nav-btn:hover{background:rgba(255,11,11,0.1);color:#ffcccc}
    .nav-btn.active{background:var(--red);color:white;border-color:var(--red)}
    
    /* Pages */
    .page{display:none;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:15px;box-shadow:0 6px 18px rgba(23,2,2,0.6);border:1px solid rgba(255,11,11,0.12);min-height:500px}
    .page.active{display:block;animation:fadeIn 0.5s}
    
    /* Editor page */
    .editor-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px}
    @media(max-width:768px){.editor-grid{grid-template-columns:1fr}}
    
    .input-group{margin-bottom:10px}
    h1{color:#ffe6e6;margin:0 0 12px 0;font-size:20px;border-bottom:2px solid rgba(255,11,11,0.3);padding-bottom:6px}
    h2{color:#ffcccc;margin:12px 0 8px 0;font-size:16px}
    label{display:block;margin:6px 0 4px;color:var(--muted);font-size:13px}
    input[type=text], input[type=number], textarea{width:100%;padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.3);color:#ffe6e6;font-size:14px;resize:vertical}
    input[type=text]:focus, input[type=number]:focus, textarea:focus{outline:none;border-color:var(--red-light);box-shadow:0 0 0 2px rgba(255,61,61,0.2)}
    
    .button-group{display:flex;flex-wrap:wrap;gap:6px;margin:12px 0}
    button{background:var(--red);color:white;padding:8px 12px;border-radius:6px;border:none;cursor:pointer;font-weight:600;transition:all 0.2s;font-size:13px}
    button:hover{background:var(--red-light);transform:translateY(-1px)}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.1);color:#ffcccc}
    button.ghost:hover{background:rgba(255,255,255,0.05);border-color:var(--red-light)}
    button.small{font-size:12px;padding:6px 10px}
    button.wide{width:100%}
    
    /* Word list */
    .list-container{margin-top:15px;border:1px solid rgba(255,11,11,0.1);border-radius:6px;overflow:hidden}
    .list-header{background:rgba(255,11,11,0.1);padding:10px;display:flex;justify-content:space-between;color:#ffcccc;font-weight:600;font-size:13px}
    .word-list{height:350px;overflow:auto;background:linear-gradient(180deg, rgba(0,0,0,0.3), rgba(0,0,0,0.2))}
    @media(max-width:768px){.word-list{height:250px}}
    
    .word-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);transition:background 0.2s;font-size:13px}
    .word-item:hover{background:rgba(255,11,11,0.05)}
    .word-content{flex-grow:1}
    .word-text{font-size:14px;color:#ffebeb;font-weight:500}
    .word-meaning{font-size:12px;color:var(--muted);margin-top:3px}
    .word-actions{display:flex;gap:5px;flex-shrink:0}
    
    /* Quiz page */
    .quiz-container{max-width:600px;margin:0 auto}
    .quiz-header{text-align:center;margin-bottom:20px}
    .quiz-stats{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding:12px;background:rgba(255,11,11,0.08);border-radius:8px;border:1px solid rgba(255,11,11,0.2)}
    .stat-box{text-align:center}
    .stat-value{font-size:24px;color:#ffebeb;font-weight:bold}
    .stat-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
    
    .quiz-question{background:linear-gradient(90deg, rgba(255,11,11,0.15), rgba(58,6,6,0.15));padding:15px;border-radius:10px;margin-bottom:20px;color:#ffebeb;font-size:18px;text-align:center;min-height:100px;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,11,11,0.2)}
    
    .quiz-options{display:grid;gap:10px;margin-bottom:15px}
    .quiz-option{padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.3);cursor:pointer;text-align:center;font-size:14px;color:#ffebeb;transition:all 0.2s}
    .quiz-option:hover{background:rgba(255,11,11,0.1);border-color:var(--red-light)}
    .quiz-option.correct{background:rgba(25,181,107,0.2);border-color:var(--green);color:#d1ffe9}
    .quiz-option.wrong{background:rgba(255,77,77,0.2);border-color:#ff4d4d;color:#ffd1d1}
    
    .quiz-controls{display:flex;gap:8px;justify-content:center;margin-top:20px}
    
    /* Writing exercise page */
    .writing-container{max-width:600px;margin:0 auto}
    
    .writing-prompt{background:linear-gradient(90deg, rgba(255,11,11,0.1), rgba(58,6,6,0.1));padding:20px;border-radius:10px;margin-bottom:20px;border:2px solid rgba(255,11,11,0.2);text-align:center}
    .writing-prompt-text{font-size:20px;color:#ffcccc;margin-bottom:12px}
    .writing-hint{font-size:13px;color:var(--muted);font-style:italic;margin-top:8px}
    
    .writing-input-container{margin:20px 0}
    .writing-input-label{display:block;margin-bottom:8px;color:#ffcccc;font-size:14px}
    .writing-input{width:100%;padding:12px;font-size:16px;text-align:center;letter-spacing:1px}
    
    .writing-feedback{min-height:50px;margin:15px 0;padding:12px;border-radius:8px;transition:all 0.3s;text-align:center;font-size:14px}
    .writing-feedback.correct{background:rgba(25,181,107,0.15);border:1px solid var(--green);color:#d1ffe9}
    .writing-feedback.incorrect{background:rgba(255,77,77,0.15);border:1px solid #ff4d4d;color:#ffd1d1}
    .writing-feedback.show-answer{background:rgba(255,165,0,0.15);border:1px solid #ffa500;color:#fff0d1}
    
    .writing-answer{font-size:20px;color:#ffcccc;font-weight:bold;margin:8px 0}
    
    /* Memory Game page - SMALLER CARDS */
    .memory-container{max-width:800px;margin:0 auto}
    .memory-stats{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding:12px;background:rgba(255,11,11,0.08);border-radius:8px;border:1px solid rgba(255,11,11,0.2)}
    
    .memory-grid{display:grid;grid-template-columns:repeat(4, 1fr);gap:10px;margin:20px auto}
    @media(max-width:768px){.memory-grid{grid-template-columns:repeat(3, 1fr)}}
    @media(max-width:480px){.memory-grid{grid-template-columns:repeat(2, 1fr)}}
    
    .memory-card{
      aspect-ratio:3/4;
      border-radius:8px;
      cursor:pointer;
      transition:all 0.3s;
      position:relative;
      transform-style:preserve-3d;
      perspective:1000px;
    }
    
    .memory-card-inner{
      position:relative;
      width:100%;
      height:100%;
      text-align:center;
      transition:transform 0.6s;
      transform-style:preserve-3d;
      border-radius:6px;
    }
    
    .memory-card.flipped .memory-card-inner{
      transform:rotateY(180deg);
    }
    
    .memory-card.matched{
      cursor:default;
      opacity:0.7;
    }
    
    .memory-card.matched .card-front{
      background:linear-gradient(145deg, rgba(25,181,107,0.8), rgba(20,150,90,0.8));
      border:2px solid var(--green);
    }
    
    .card-front, .card-back{
      position:absolute;
      width:100%;
      height:100%;
      backface-visibility:hidden;
      border-radius:6px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px;
      text-align:center;
      font-weight:bold;
      -webkit-backface-visibility:hidden;
      backface-visibility:hidden;
    }
    
    .card-back{
      background:linear-gradient(145deg, rgba(255,11,11,0.8), rgba(58,6,6,0.8));
      color:#ffebeb;
      font-size:28px;
      border:2px solid rgba(255,11,11,0.5);
    }
    
    .card-front{
      background:linear-gradient(145deg, rgba(0,0,0,0.8), rgba(20,0,0,0.8));
      color:#ffebeb;
      transform:rotateY(180deg);
      font-size:16px;
      line-height:1.3;
      border:2px solid rgba(255,11,11,0.3);
      flex-direction:column;
    }
    
    .card-flag{
      font-size:20px;
      margin-bottom:8px;
    }
    
    .card-text{
      font-size:14px;
      word-break:break-word;
    }
    
    .memory-controls{display:flex;gap:8px;justify-content:center;margin-top:20px}
    
    /* Mistake Review Page - WORKING MISTAKE REVIEW */
    .mistakes-review-container{max-width:600px;margin:0 auto}
    
    .mistake-review-exercise{
      background:linear-gradient(90deg, rgba(255,11,11,0.1), rgba(58,6,6,0.1));
      padding:15px;
      border-radius:10px;
      margin-bottom:15px;
      border:2px solid rgba(255,11,11,0.3);
    }
    
    .mistake-meta{
      display:flex;
      justify-content:space-between;
      margin-bottom:10px;
      font-size:12px;
      color:var(--muted);
    }
    
    .mistake-review-type{
      background:rgba(255,11,11,0.2);
      padding:3px 6px;
      border-radius:4px;
    }
    
    .mistake-review-question{
      font-size:18px;
      color:#ffcccc;
      margin-bottom:15px;
      text-align:center;
    }
    
    .mistake-review-answer{
      display:flex;
      justify-content:space-between;
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid rgba(255,255,255,0.1);
    }
    
    .mistake-review-correct{
      color:#19b56b;
      font-size:14px;
    }
    
    .mistake-review-wrong{
      color:#ff4d4d;
      font-size:14px;
    }
    
    .mistake-review-input{
      width:100%;
      padding:10px;
      margin-top:10px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(0,0,0,0.3);
      color:#ffe6e6;
      font-size:14px;
      text-align:center;
    }
    
    .mistake-review-feedback{
      min-height:40px;
      margin:10px 0;
      padding:10px;
      border-radius:6px;
      text-align:center;
      font-size:14px;
    }
    
    .mistake-review-controls{display:flex;gap:8px;justify-content:center;margin-top:15px}
    
    .empty-state{text-align:center;padding:40px 20px;color:var(--muted)}
    .empty-state-icon{font-size:48px;margin-bottom:15px}
    
    /* Exercise selector */
    .exercise-selector{margin:15px 0;padding:12px;background:rgba(255,11,11,0.08);border-radius:8px}
    .exercise-buttons{display:grid;grid-template-columns:repeat(2, 1fr);gap:10px;margin-top:12px}
    @media(max-width:600px){.exercise-buttons{grid-template-columns:1fr}}
    
    .exercise-btn{background:rgba(255,11,11,0.1);border:1px solid rgba(255,11,11,0.3);padding:15px;border-radius:8px;cursor:pointer;transition:all 0.3s;text-align:center}
    .exercise-btn:hover{background:rgba(255,11,11,0.2);transform:translateY(-2px)}
    .exercise-btn .icon{font-size:32px;margin-bottom:8px}
    .exercise-btn .title{font-size:16px;color:#ffcccc;font-weight:bold;margin-bottom:6px}
    .exercise-btn .desc{font-size:12px;color:var(--muted)}
    
    /* Animations */
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}
    @keyframes flip{0%{transform:rotateY(0)}50%{transform:rotateY(90deg)}100%{transform:rotateY(180deg)}}
    @keyframes match{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    @keyframes shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-3px)}20%,40%,60%,80%{transform:translateX(3px)}}
    
    .shake{animation:shake 0.5s}
    
    footer{text-align:center;margin-top:15px;color:rgba(255,255,255,0.2);font-size:11px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.05)}
  </style>
</head>
<body>
  <div class="app">
    <!-- Navigation -->
    <div class="nav-bar">
      <button class="nav-btn active" data-page="editor">âœï¸ Ù…Ø­Ø±Ø±</button>
      <button class="nav-btn" data-page="exercises">ğŸ¯ ØªÙ…Ø§Ø±ÙŠÙ†</button>
      <button class="nav-btn" data-page="quiz">â“ Ø§Ø®ØªÙŠØ§Ø±</button>
      <button class="nav-btn" data-page="writing">âœï¸ ÙƒØªØ§Ø¨Ø©</button>
      <button class="nav-btn" data-page="memory">ğŸ´ Ø°Ø§ÙƒØ±Ø©</button>
      <button class="nav-btn" data-page="mistakes">ğŸ“Š Ø£Ø®Ø·Ø§Ø¡</button>
      <button class="nav-btn" data-page="settings">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>

    <!-- Editor Page -->
    <div class="page active" id="editor-page">
      <div class="editor-grid">
        <div>
          <h1>Ø£Ø¶Ù ÙƒÙ„Ù…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</h1>
          <div class="input-group">
            <label>Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ©</label>
            <input id="german" type="text" placeholder="Ù…Ø«Ø§Ù„: Apfel" />
          </div>
          <div class="input-group">
            <label>Ø§Ù„Ù…Ø¹Ù†Ù‰ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</label>
            <input id="english" type="text" placeholder="Ù…Ø«Ø§Ù„: Apple" />
          </div>
          
          <div class="button-group">
            <button id="add">â• Ø£Ø¶Ù</button>
            <button id="pron" class="ghost">ğŸ”Š Ù†Ø·Ù‚</button>
            <button id="clear-inputs" class="ghost">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
          </div>
          
          <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
          <div class="button-group">
            <button id="save" class="ghost">ğŸ’¾ Ø­ÙØ¸ JSON</button>
            <button id="load" class="ghost">ğŸ“‚ ØªØ­Ù…ÙŠÙ„ JSON</button>
            <button id="csv" class="ghost">ğŸ“Š ØªØµØ¯ÙŠØ± CSV</button>
          </div>
        </div>
        
        <div>
          <h1>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª (<span id="wordCount">0</span>)</h1>
          <div class="list-container">
            <div class="list-header">
              <span>Ø£Ù„Ù…Ø§Ù†ÙŠØ©</span>
              <span>Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</span>
            </div>
            <div class="word-list" id="wordList"></div>
          </div>
          
          <div class="button-group" style="margin-top:12px">
            <button id="clear-all" class="ghost" style="background:rgba(255,77,77,0.2);color:#ff9999">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
            <button id="shuffle-words" class="ghost">ğŸ”€ Ø¹Ø´ÙˆØ§Ø¦ÙŠ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Exercises Selector Page -->
    <div class="page" id="exercises-page">
      <div class="quiz-container">
        <h1>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</h1>
        
        <div class="exercise-selector">
          <p style="color:#ffcccc; text-align:center; margin-bottom:15px; font-size:14px">
            Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ…Ø±ÙŠÙ† Ù„ØªØ­Ø³ÙŠÙ† Ù…Ù‡Ø§Ø±Ø§ØªÙƒ ÙÙŠ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ©.
          </p>
          
          <div class="exercise-buttons">
            <button class="exercise-btn" data-exercise="quiz">
              <div class="icon">â“</div>
              <div class="title">Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªØ¹Ø¯Ø¯</div>
              <div class="desc">Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</div>
            </button>
            
            <button class="exercise-btn" data-exercise="writing">
              <div class="icon">âœï¸</div>
              <div class="title">ØªÙ…Ø±ÙŠÙ† Ø§Ù„ÙƒØªØ§Ø¨Ø©</div>
              <div class="desc">Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ©</div>
            </button>
            
            <button class="exercise-btn" data-exercise="memory">
              <div class="icon">ğŸ´</div>
              <div class="title">Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©</div>
              <div class="desc">Ø§Ø·Ø¨Ø¹ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ØªØ·Ø§Ø¨Ù‚Ø©</div>
            </button>
            
            <button class="exercise-btn" data-exercise="mistakes">
              <div class="icon">ğŸ“Š</div>
              <div class="title">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</div>
              <div class="desc">ØªÙ…Ø±Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
            </button>
          </div>
        </div>
        
        <div style="margin-top:20px; padding:15px; background:rgba(255,11,11,0.05); border-radius:8px">
          <h2 style="color:#ffcccc; font-size:16px">Ù†ØµØ§Ø¦Ø­ Ù„Ù„ØªØ¹Ù„Ù…</h2>
          <ul style="color:var(--muted); padding-left:15px; font-size:13px; margin:0">
            <li>Ø§Ø¨Ø¯Ø£ Ø¨ØªÙ…Ø±ÙŠÙ† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯</li>
            <li>Ø§Ø³ØªØ®Ø¯Ù… ØªÙ…Ø±ÙŠÙ† Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ‡Ø¬Ø¦Ø©</li>
            <li>Ø§Ù„Ø¹Ø¨ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¢Ø®Ø± 8 ÙƒÙ„Ù…Ø§Øª</li>
            <li>Ø±Ø§Ø¬Ø¹ Ø£Ø®Ø·Ø§Ø¡Ùƒ Ø¨Ø§Ù†ØªØ¸Ø§Ù…</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Quiz Page -->
    <div class="page" id="quiz-page">
      <div class="quiz-container">
        <h1>Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</h1>
        
        <div class="quiz-stats">
          <div class="stat-box">
            <div class="stat-value" id="quiz-score">0/0</div>
            <div class="stat-label">Ø§Ù„Ù†ØªÙŠØ¬Ø©</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="quiz-remaining">0</div>
            <div class="stat-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="quiz-accuracy">0%</div>
            <div class="stat-label">Ø§Ù„Ø¯Ù‚Ø©</div>
          </div>
        </div>
        
        <div class="quiz-question" id="quiz-prompt">
          Ø£Ø¶Ù ÙƒÙ„Ù…Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±"
        </div>
        
        <div class="quiz-options" id="quiz-opts"></div>
        
        <div class="quiz-controls">
          <button id="start-quiz" style="background:linear-gradient(135deg, var(--red), #ff3d3d);padding:10px 20px;font-size:14px">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
          <button id="next-question" class="ghost" style="display:none">â­ï¸ Ø§Ù„ØªØ§Ù„ÙŠ</button>
          <button id="end-quiz" class="ghost" style="display:none">â¹ï¸ Ø¥Ù†Ù‡Ø§Ø¡</button>
          <button id="back-to-exercises-quiz" class="ghost">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        </div>
      </div>
    </div>

    <!-- Writing Exercise Page -->
    <div class="page" id="writing-page">
      <div class="writing-container">
        <h1>ØªÙ…Ø±ÙŠÙ† Ø§Ù„ÙƒØªØ§Ø¨Ø©</h1>
        
        <div class="quiz-stats">
          <div class="stat-box">
            <div class="stat-value" id="writing-score">0/0</div>
            <div class="stat-label">Ø§Ù„Ù†ØªÙŠØ¬Ø©</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="writing-remaining">0</div>
            <div class="stat-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="writing-accuracy">0%</div>
            <div class="stat-label">Ø§Ù„Ø¯Ù‚Ø©</div>
          </div>
        </div>
        
        <div class="writing-prompt">
          <div class="writing-prompt-text" id="writing-prompt">
            Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ…Ø±ÙŠÙ†" Ù„Ø¨Ø¯Ø¡ ØªÙ…Ø±ÙŠÙ† Ø§Ù„ÙƒØªØ§Ø¨Ø©
          </div>
          <div class="writing-hint" id="writing-hint">
            Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù…Ø¹Ù†Ù‰ Ø§Ù„Ù…Ø¹Ø·Ù‰
          </div>
        </div>
        
        <div class="writing-input-container">
          <label class="writing-input-label" id="writing-input-label">Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© Ù‡Ù†Ø§:</label>
          <input type="text" class="writing-input" id="writing-input" placeholder="...Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ" disabled />
        </div>
        
        <div class="writing-feedback" id="writing-feedback"></div>
        
        <div class="quiz-controls">
          <button id="start-writing" style="background:linear-gradient(135deg, var(--red), #ff3d3d);padding:10px 20px;font-size:14px">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</button>
          <button id="check-answer" class="ghost" style="display:none">âœ“ ØªØ­Ù‚Ù‚</button>
          <button id="next-writing" class="ghost" style="display:none">â­ï¸ Ø§Ù„ØªØ§Ù„ÙŠ</button>
          <button id="show-answer" class="ghost" style="display:none">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
          <button id="end-writing" class="ghost" style="display:none">â¹ï¸ Ø¥Ù†Ù‡Ø§Ø¡</button>
          <button id="back-to-exercises-writing" class="ghost">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        </div>
      </div>
    </div>

    <!-- Memory Game Page - USES LAST 8 WORDS -->
    <div class="page" id="memory-page">
      <div class="memory-container">
        <h1>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© ğŸ´</h1>
        
        <div class="memory-stats">
          <div class="stat-box">
            <div class="stat-value" id="memory-moves">0</div>
            <div class="stat-label">Ø§Ù„Ø­Ø±ÙƒØ§Øª</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="memory-matched">0</div>
            <div class="stat-label">Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="memory-time">0:00</div>
            <div class="stat-label">Ø§Ù„ÙˆÙ‚Øª</div>
          </div>
        </div>
        
        <div style="margin:10px 0; padding:10px; background:rgba(255,11,11,0.05); border-radius:6px; text-align:center;">
          <div style="color:#ffcccc; font-size:14px; margin-bottom:5px">âš ï¸ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¢Ø®Ø± 8 ÙƒÙ„Ù…Ø§Øª Ù…Ù† Ù‚Ø§Ø¦Ù…ØªÙƒ</div>
          <div style="color:var(--muted); font-size:12px">(4 Ø£Ø²ÙˆØ§Ø¬: Ø£Ù„Ù…Ø§Ù†ÙŠØ© â†” Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)</div>
        </div>
        
        <div class="memory-grid" id="memory-grid">
          <div style="grid-column:1/-1;text-align:center;padding:30px;color:var(--muted);font-size:14px">
            Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©" Ù„Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¢Ø®Ø± 8 ÙƒÙ„Ù…Ø§Øª
          </div>
        </div>
        
        <div class="memory-controls">
          <button id="start-memory" style="background:linear-gradient(135deg, var(--red), #ff3d3d);padding:10px 20px;font-size:14px">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
          <button id="restart-memory" class="ghost" style="display:none">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø©</button>
          <button id="back-to-exercises-memory" class="ghost">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        </div>
        
        <div id="memory-complete" style="display:none;text-align:center;margin-top:20px;padding:15px;background:rgba(25,181,107,0.1);border-radius:8px;border:1px solid var(--green)">
          <div style="font-size:36px">ğŸ‰</div>
          <div style="font-size:20px;color:#ffcccc;margin:8px 0">Ø£Ø­Ø³Ù†Øª! Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</div>
          <div style="color:var(--muted);font-size:13px">Ø­Ø±ÙƒØ§Øª: <span id="final-moves">0</span> | ÙˆÙ‚Øª: <span id="final-time">0:00</span></div>
          <button class="ghost" style="margin-top:10px;padding:8px 15px" onclick="restartMemoryGame()">ğŸ”„ Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
        </div>
      </div>
    </div>

    <!-- Mistake Review Page - WORKING MISTAKE REVIEW -->
    <div class="page" id="mistakes-page">
      <div class="mistakes-review-container">
        <h1>ğŸ“Š Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</h1>
        
        <div class="quiz-stats">
          <div class="stat-box">
            <div class="stat-value" id="total-mistakes">0</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="remaining-mistakes">0</div>
            <div class="stat-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="review-accuracy">0%</div>
            <div class="stat-label">Ø§Ù„Ø¯Ù‚Ø©</div>
          </div>
        </div>
        
        <div id="mistake-review-exercise" style="display:none">
          <div class="mistake-review-exercise">
            <div class="mistake-meta">
              <span class="mistake-review-type" id="review-type">â“ Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªØ¹Ø¯Ø¯</span>
              <span id="review-progress">1/10</span>
            </div>
            <div class="mistake-review-question" id="review-question">
              What is the German word for "Apple"?
            </div>
            
            <!-- Quiz Type Exercise -->
            <div id="review-quiz-options" style="display:none">
              <div class="quiz-options" id="review-opts"></div>
            </div>
            
            <!-- Writing Type Exercise -->
            <div id="review-writing-input" style="display:none">
              <input type="text" class="mistake-review-input" id="review-answer-input" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§..." />
              <div class="mistake-review-feedback" id="review-feedback"></div>
            </div>
            
            <div class="mistake-review-answer" id="review-previous-answer" style="display:none">
              <div class="mistake-review-correct">âœ… <span id="review-correct-answer">Apfel</span></div>
              <div class="mistake-review-wrong">âŒ <span id="review-wrong-answer">Birne</span></div>
            </div>
          </div>
          
          <div class="mistake-review-controls">
            <button id="check-review-answer" class="ghost">âœ“ ØªØ­Ù‚Ù‚</button>
            <button id="next-mistake" class="ghost" style="display:none">â­ï¸ Ø§Ù„ØªØ§Ù„ÙŠ</button>
            <button id="show-review-answer" class="ghost">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
            <button id="end-review" class="ghost">â¹ï¸ Ø¥Ù†Ù‡Ø§Ø¡</button>
          </div>
        </div>
        
        <div id="no-mistakes-review" class="empty-state">
          <div class="empty-state-icon">âœ…</div>
          <h2 style="color:#ffcccc;font-size:18px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©!</h2>
          <p style="color:var(--muted);margin-top:8px;font-size:13px">Ø§Ø³ØªÙ…Ø± ÙÙŠ Ù…Ù…Ø§Ø±Ø³Ø© Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†ØŒ ÙˆØ³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
          <button class="ghost" style="margin-top:15px;padding:8px 15px" onclick="document.querySelector('[data-page=\"exercises\"]').click()">ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</button>
        </div>
        
        <div id="review-complete" class="empty-state" style="display:none">
          <div class="empty-state-icon">ğŸ‰</div>
          <h2 style="color:#ffcccc;font-size:18px">Ø£ÙƒÙ…Ù„Øª Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡!</h2>
          <p style="color:var(--muted);margin-top:8px;font-size:13px">Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: <span id="final-review-accuracy">0%</span></p>
          <button class="ghost" style="margin-top:15px;padding:8px 15px" onclick="startMistakeReview()">ğŸ”„ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø£Ø®Ø±Ù‰</button>
        </div>
        
        <div class="button-group" style="margin-top:20px;justify-content:center">
          <button id="start-review" class="ghost" style="display:none">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
          <button id="clear-mistakes" class="ghost" style="background:rgba(255,77,77,0.2);color:#ff9999">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</button>
        </div>
      </div>
    </div>

    <!-- Settings Page -->
    <div class="page" id="settings-page">
      <h1>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h1>
      
      <div class="settings-group">
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†</h2>
        <div class="setting-item">
          <span>Ø¹Ø¯Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</span>
          <select id="optionsCount" style="background:rgba(0,0,0,0.3);color:#ffebeb;border:1px solid rgba(255,255,255,0.1);padding:5px 8px;border-radius:6px;font-size:13px">
            <option value="2">2 Ø®ÙŠØ§Ø±Ø§Øª</option>
            <option value="3">3 Ø®ÙŠØ§Ø±Ø§Øª</option>
            <option value="4" selected>4 Ø®ÙŠØ§Ø±Ø§Øª</option>
            <option value="5">5 Ø®ÙŠØ§Ø±Ø§Øª</option>
            <option value="6">6 Ø®ÙŠØ§Ø±Ø§Øª</option>
          </select>
        </div>
        
        <div class="setting-item">
          <span>Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙÙŠ Ø§Ù„ØªÙ…Ø±ÙŠÙ†:</span>
          <input type="number" id="exerciseLimit" min="5" max="100" value="20" style="width:70px;text-align:center;font-size:13px;padding:5px" />
        </div>
        
        <div class="setting-item">
          <span>Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:</span>
          <label style="cursor:pointer;font-size:13px">
            <input type="checkbox" id="usePron" checked />
            <span style="margin-left:6px">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø·Ù‚</span>
          </label>
        </div>
      </div>
      
      <div class="settings-group">
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨Ø©</h2>
        <div class="setting-item">
          <span>ØªØ³Ø§Ù…Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¥Ù…Ù„Ø§Ø¦ÙŠØ©:</span>
          <label style="cursor:pointer;font-size:13px">
            <input type="checkbox" id="spellingTolerance" checked />
            <span style="margin-left:6px">ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¨Ø³ÙŠØ·Ø©</span>
          </label>
        </div>
      </div>
      
      <div class="button-group" style="margin-top:20px;justify-content:center">
        <button id="reset-settings" class="ghost">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·</button>
        <button id="export-data" class="ghost">ğŸ“¦ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
      </div>
    </div>

    <footer>German Trainer â€” Ù…Ù„Ù HTML ÙˆØ§Ø­Ø¯ ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ | ÙŠØ¯Ø¹Ù… Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙˆØ§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ§Ù„ØªØµØ¯ÙŠØ±</footer>
  </div>

  <!-- Hidden file input -->
  <input id="fileInput" type="file" accept="application/json" style="display:none" />

  <script>
    // Data & storage
    const WORDS_KEY = 'german_trainer_words_v6';
    const SETTINGS_KEY = 'german_trainer_settings';
    const MISTAKES_KEY = 'german_trainer_mistakes';
    
    let words = JSON.parse(localStorage.getItem(WORDS_KEY) || '[]');
    let settings = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{"optionsCount":4,"usePron":true,"exerciseLimit":20,"spellingTolerance":true,"themeColor":"#ff0b0b"}');
    let mistakes = JSON.parse(localStorage.getItem(MISTAKES_KEY) || '[]');
    
    // Exercise variables
    let quizQueue = [];
    let writingQueue = [];
    let memoryCards = [];
    let reviewQueue = [];
    let currentQuizWord = null;
    let currentWritingWord = null;
    let currentReviewMistake = null;
    let quizCorrect = 0, quizAttempts = 0;
    let writingCorrect = 0, writingAttempts = 0;
    let reviewCorrect = 0, reviewAttempts = 0;
    let quizActive = false;
    let writingActive = false;
    let memoryActive = false;
    let reviewActive = false;
    let memoryMoves = 0;
    let memoryMatched = 0;
    let memoryStartTime = 0;
    let memoryTimer = null;
    let flippedCards = [];
    let canFlip = true;

    // UI refs
    const germanInput = document.getElementById('german');
    const englishInput = document.getElementById('english');
    const addBtn = document.getElementById('add');
    const pronBtn = document.getElementById('pron');
    const listEl = document.getElementById('wordList');
    const wordCountEl = document.getElementById('wordCount');
    const saveBtn = document.getElementById('save');
    const loadBtn = document.getElementById('load');
    const csvBtn = document.getElementById('csv');
    const clearAllBtn = document.getElementById('clear-all');
    const clearInputsBtn = document.getElementById('clear-inputs');
    const shuffleWordsBtn = document.getElementById('shuffle-words');
    
    // Quiz elements
    const startQuizBtn = document.getElementById('start-quiz');
    const nextQuizBtn = document.getElementById('next-question');
    const endQuizBtn = document.getElementById('end-quiz');
    const optsCount = document.getElementById('optionsCount');
    const exerciseLimit = document.getElementById('exerciseLimit');
    const themeColor = document.getElementById('themeColor');
    const spellingTolerance = document.getElementById('spellingTolerance');
    const quizOptsEl = document.getElementById('quiz-opts');
    const quizPromptEl = document.getElementById('quiz-prompt');
    const quizScoreEl = document.getElementById('quiz-score');
    const quizRemainingEl = document.getElementById('quiz-remaining');
    const quizAccuracyEl = document.getElementById('quiz-accuracy');
    
    // Writing elements
    const startWritingBtn = document.getElementById('start-writing');
    const checkAnswerBtn = document.getElementById('check-answer');
    const nextWritingBtn = document.getElementById('next-writing');
    const showAnswerBtn = document.getElementById('show-answer');
    const endWritingBtn = document.getElementById('end-writing');
    const writingPromptEl = document.getElementById('writing-prompt');
    const writingHintEl = document.getElementById('writing-hint');
    const writingInput = document.getElementById('writing-input');
    const writingFeedback = document.getElementById('writing-feedback');
    const writingScoreEl = document.getElementById('writing-score');
    const writingRemainingEl = document.getElementById('writing-remaining');
    const writingAccuracyEl = document.getElementById('writing-accuracy');
    
    // Memory game elements
    const startMemoryBtn = document.getElementById('start-memory');
    const restartMemoryBtn = document.getElementById('restart-memory');
    const memoryGrid = document.getElementById('memory-grid');
    const memoryMovesEl = document.getElementById('memory-moves');
    const memoryMatchedEl = document.getElementById('memory-matched');
    const memoryTimeEl = document.getElementById('memory-time');
    const memoryComplete = document.getElementById('memory-complete');
    const finalMovesEl = document.getElementById('final-moves');
    const finalTimeEl = document.getElementById('final-time');
    
    // Mistake review elements
    const mistakeReviewExercise = document.getElementById('mistake-review-exercise');
    const noMistakesReview = document.getElementById('no-mistakes-review');
    const reviewComplete = document.getElementById('review-complete');
    const totalMistakesEl = document.getElementById('total-mistakes');
    const remainingMistakesEl = document.getElementById('remaining-mistakes');
    const reviewAccuracyEl = document.getElementById('review-accuracy');
    const startReviewBtn = document.getElementById('start-review');
    const clearMistakesBtn = document.getElementById('clear-mistakes');
    const reviewTypeEl = document.getElementById('review-type');
    const reviewProgressEl = document.getElementById('review-progress');
    const reviewQuestionEl = document.getElementById('review-question');
    const reviewQuizOptions = document.getElementById('review-quiz-options');
    const reviewWritingInput = document.getElementById('review-writing-input');
    const reviewAnswerInput = document.getElementById('review-answer-input');
    const reviewFeedback = document.getElementById('review-feedback');
    const reviewPreviousAnswer = document.getElementById('review-previous-answer');
    const reviewCorrectAnswerEl = document.getElementById('review-correct-answer');
    const reviewWrongAnswerEl = document.getElementById('review-wrong-answer');
    const reviewOptsEl = document.getElementById('review-opts');
    const checkReviewAnswerBtn = document.getElementById('check-review-answer');
    const nextMistakeBtn = document.getElementById('next-mistake');
    const showReviewAnswerBtn = document.getElementById('show-review-answer');
    const endReviewBtn = document.getElementById('end-review');
    const finalReviewAccuracy = document.getElementById('final-review-accuracy');
    
    // Navigation
    const navBtns = document.querySelectorAll('.nav-btn');
    const pages = document.querySelectorAll('.page');
    const exerciseBtns = document.querySelectorAll('.exercise-btn');
    
    // File input
    const fileInput = document.getElementById('fileInput');

    // ===== CORE FUNCTIONS =====
    
    // Initialize settings
    function initSettings() {
      optsCount.value = settings.optionsCount || 4;
      document.getElementById('usePron').checked = settings.usePron !== false;
      exerciseLimit.value = settings.exerciseLimit || 20;
      spellingTolerance.checked = settings.spellingTolerance !== false;
      updateMistakeReviewUI();
    }

    // Save settings
    function saveSettings() {
      settings.optionsCount = parseInt(optsCount.value);
      settings.usePron = document.getElementById('usePron').checked;
      settings.exerciseLimit = parseInt(exerciseLimit.value);
      settings.spellingTolerance = spellingTolerance.checked;
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
    }

    // Save mistakes
    function saveMistakes() {
      localStorage.setItem(MISTAKES_KEY, JSON.stringify(mistakes));
      updateMistakeReviewUI();
    }

    // Add a mistake
    function addMistake(exerciseType, question, correctAnswer, wrongAnswer) {
      // Create the mistake
      const mistake = {
        id: Date.now() + Math.random(),
        type: exerciseType,
        question: question,
        correct: correctAnswer,
        wrong: wrongAnswer,
        date: new Date().toISOString(),
        reviewed: false
      };
      
      // Add to mistakes array
      mistakes.push(mistake);
      
      // Keep only last 100 mistakes to avoid too much storage
      if (mistakes.length > 100) {
        mistakes = mistakes.slice(-100);
      }
      
      saveMistakes();
    }

    // Update mistake review UI
    function updateMistakeReviewUI() {
      const total = mistakes.length;
      const remaining = mistakes.filter(m => !m.reviewed).length;
      const accuracy = reviewAttempts > 0 ? Math.round((reviewCorrect / reviewAttempts) * 100) : 0;
      
      totalMistakesEl.textContent = total;
      remainingMistakesEl.textContent = remaining;
      reviewAccuracyEl.textContent = `${accuracy}%`;
      
      if (total === 0) {
        noMistakesReview.style.display = 'block';
        mistakeReviewExercise.style.display = 'none';
        reviewComplete.style.display = 'none';
        startReviewBtn.style.display = 'none';
      } else if (reviewActive) {
        noMistakesReview.style.display = 'none';
        mistakeReviewExercise.style.display = 'block';
        reviewComplete.style.display = 'none';
        startReviewBtn.style.display = 'none';
      } else if (remaining === 0 && total > 0) {
        noMistakesReview.style.display = 'none';
        mistakeReviewExercise.style.display = 'none';
        reviewComplete.style.display = 'block';
        startReviewBtn.style.display = 'inline-block';
      } else {
        noMistakesReview.style.display = 'none';
        mistakeReviewExercise.style.display = 'none';
        reviewComplete.style.display = 'none';
        startReviewBtn.style.display = 'inline-block';
      }
    }

    // Start mistake review
    function startMistakeReview() {
      if (mistakes.length === 0) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©');
        return;
      }
      
      // Get unreviewed mistakes
      reviewQueue = mistakes.filter(m => !m.reviewed);
      
      if (reviewQueue.length === 0) {
        // If all reviewed, review all mistakes again
        reviewQueue = [...mistakes];
        // Reset reviewed status
        mistakes.forEach(m => m.reviewed = false);
        saveMistakes();
      }
      
      // Shuffle the review queue
      reviewQueue = shuffle(reviewQueue);
      
      reviewActive = true;
      reviewCorrect = 0;
      reviewAttempts = 0;
      
      // Reset UI
      reviewQuizOptions.style.display = 'none';
      reviewWritingInput.style.display = 'none';
      reviewPreviousAnswer.style.display = 'none';
      checkReviewAnswerBtn.style.display = 'inline-block';
      nextMistakeBtn.style.display = 'none';
      showReviewAnswerBtn.style.display = 'inline-block';
      reviewFeedback.textContent = '';
      reviewFeedback.className = 'mistake-review-feedback';
      reviewAnswerInput.value = '';
      
      updateMistakeReviewUI();
      nextReviewQuestion();
    }

    // Next review question
    function nextReviewQuestion() {
      if (reviewQueue.length === 0) {
        endMistakeReview();
        return;
      }
      
      currentReviewMistake = reviewQueue.pop();
      
      // Update UI based on mistake type
      reviewProgressEl.textContent = `${reviewAttempts + 1}/${reviewAttempts + reviewQueue.length + 1}`;
      reviewQuestionEl.textContent = currentReviewMistake.question;
      reviewCorrectAnswerEl.textContent = currentReviewMistake.correct;
      reviewWrongAnswerEl.textContent = currentReviewMistake.wrong;
      
      // Show previous answer
      reviewPreviousAnswer.style.display = 'flex';
      
      if (currentReviewMistake.type === 'quiz') {
        reviewTypeEl.textContent = 'â“ Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªØ¹Ø¯Ø¯';
        reviewTypeEl.style.background = 'rgba(255,11,11,0.2)';
        
        // Create quiz options
        reviewQuizOptions.style.display = 'block';
        reviewWritingInput.style.display = 'none';
        
        const numOpts = Math.max(2, Math.min(6, parseInt(optsCount.value) || 4));
        const choices = buildChoices(currentReviewMistake.correct, numOpts, words.map(w => w.german));
        renderReviewOptions(choices);
        
      } else if (currentReviewMistake.type === 'writing') {
        reviewTypeEl.textContent = 'âœï¸ ÙƒØªØ§Ø¨Ø©';
        reviewTypeEl.style.background = 'rgba(255,165,0,0.2)';
        
        reviewQuizOptions.style.display = 'none';
        reviewWritingInput.style.display = 'block';
        reviewAnswerInput.disabled = false;
        reviewAnswerInput.focus();
      }
    }

    // Build choices for quiz
    function buildChoices(correctGerman, num, wordPool){
      const pool = wordPool.filter(g => g !== correctGerman);
      const choices = [correctGerman];
      
      while(choices.length < num && pool.length){
        const i = Math.floor(Math.random() * pool.length); 
        choices.push(pool.splice(i,1)[0]);
      }
      
      while(choices.length < num) choices.push(correctGerman);
      return shuffle(choices);
    }

    // Render review options
    function renderReviewOptions(choices){
      reviewOptsEl.innerHTML='';
      choices.forEach(c => {
        const opt = document.createElement('div');
        opt.className = 'quiz-option';
        opt.textContent = c;
        opt.onclick = () => reviewAnswer(c, opt);
        reviewOptsEl.appendChild(opt);
      });
    }

    // Review answer handler
    function reviewAnswer(choice, el) {
      if (el.classList.contains('correct') || el.classList.contains('wrong')) return;
      
      reviewAttempts++;
      const allOptions = document.querySelectorAll('#review-opts .quiz-option');
      
      if (choice === currentReviewMistake.correct) {
        reviewCorrect++;
        el.classList.add('correct');
        currentReviewMistake.reviewed = true;
        
        setTimeout(() => {
          allOptions.forEach(opt => opt.style.pointerEvents = 'none');
          setTimeout(nextReviewQuestion, 800);
        }, 300);
      } else {
        el.classList.add('wrong');
        
        // Highlight correct answer
        allOptions.forEach(opt => {
          if (opt.textContent === currentReviewMistake.correct) {
            opt.classList.add('correct');
          }
          opt.style.pointerEvents = 'none';
        });
        
        setTimeout(() => {
          allOptions.forEach(opt => opt.style.pointerEvents = 'none');
          checkReviewAnswerBtn.style.display = 'none';
          nextMistakeBtn.style.display = 'inline-block';
        }, 300);
      }
      
      saveMistakes();
      updateMistakeReviewUI();
    }

    // Check writing review answer
    function checkReviewWritingAnswer() {
      const userAnswer = reviewAnswerInput.value.trim();
      if (!userAnswer) {
        reviewFeedback.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¥Ø¬Ø§Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹';
        reviewFeedback.className = 'mistake-review-feedback';
        return;
      }
      
      reviewAttempts++;
      reviewAnswerInput.disabled = true;
      
      const correctAnswer = currentReviewMistake.correct;
      const normalizedUserAnswer = normalizeText(userAnswer);
      const normalizedCorrectAnswer = normalizeText(correctAnswer);
      
      // Check if answer is correct
      let isCorrect = false;
      if (spellingTolerance.checked) {
        isCorrect = normalizedUserAnswer === normalizedCorrectAnswer ||
                   Math.abs(normalizedUserAnswer.length - normalizedCorrectAnswer.length) <= 2;
        
        if (!isCorrect) {
          const distance = levenshteinDistance(normalizedUserAnswer, normalizedCorrectAnswer);
          isCorrect = distance <= 1;
        }
      } else {
        isCorrect = normalizedUserAnswer === normalizedCorrectAnswer;
      }
      
      if (isCorrect) {
        reviewCorrect++;
        reviewFeedback.innerHTML = `<div style="color:#19b56b">âœ… ØµØ­ÙŠØ­!</div>`;
        reviewFeedback.className = 'mistake-review-feedback';
        currentReviewMistake.reviewed = true;
        
        setTimeout(() => {
          nextReviewQuestion();
        }, 1000);
      } else {
        reviewFeedback.innerHTML = `<div style="color:#ff4d4d">âŒ ØºÙŠØ± ØµØ­ÙŠØ­</div>`;
        reviewFeedback.className = 'mistake-review-feedback';
        
        checkReviewAnswerBtn.style.display = 'none';
        nextMistakeBtn.style.display = 'inline-block';
      }
      
      saveMistakes();
      updateMistakeReviewUI();
    }

    // End mistake review
    function endMistakeReview() {
      reviewActive = false;
      const accuracy = reviewAttempts > 0 ? Math.round((reviewCorrect / reviewAttempts) * 100) : 0;
      finalReviewAccuracy.textContent = `${accuracy}%`;
      updateMistakeReviewUI();
    }

    // Navigation
    navBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const pageId = btn.dataset.page;
        
        // Update active nav button
        navBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Show selected page
        pages.forEach(page => page.classList.remove('active'));
        document.getElementById(`${pageId}-page`).classList.add('active');
        
        // Reset exercise states when leaving
        if (pageId !== 'quiz' && quizActive) {
          endQuiz();
        }
        if (pageId !== 'writing' && writingActive) {
          endWriting();
        }
        if (pageId !== 'memory' && memoryActive) {
          stopMemoryGame();
        }
        if (pageId !== 'mistakes' && reviewActive) {
          endMistakeReview();
        }
        
        // Update mistakes page if needed
        if (pageId === 'mistakes') {
          updateMistakeReviewUI();
        }
      });
    });

    // Exercise selection
    exerciseBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const exercise = btn.dataset.exercise;
        document.querySelector(`[data-page="${exercise}"]`).click();
      });
    });

    // ===== EDITOR FUNCTIONS =====
    
    function persist(){ localStorage.setItem(WORDS_KEY, JSON.stringify(words)); }
    
    function renderList(){
      listEl.innerHTML='';
      words.forEach((w,i)=>{
        const item = document.createElement('div');
        item.className='word-item';
        item.innerHTML = `
          <div class="word-content">
            <div class="word-text">${escapeHtml(w.german)}</div>
            <div class="word-meaning">${escapeHtml(w.english)}</div>
          </div>
          <div class="word-actions">
            <button class="small ghost" onclick="pronounce('${escapeHtml(w.german)}')" title="Ù†Ø·Ù‚">ğŸ”Š</button>
            <button class="small ghost" onclick="selectWord(${i})" title="ØªØ­Ø¯ÙŠØ¯">ğŸ“</button>
            <button class="small ghost" onclick="deleteWord(${i})" title="Ø­Ø°Ù" style="color:#ff9999">ğŸ—‘ï¸</button>
          </div>
        `;
        listEl.appendChild(item);
      });
      wordCountEl.textContent = words.length;
    }

    function escapeHtml(s){ 
      if (!s) return '';
      return s.toString().replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"
      })[c]); 
    }

    // Word functions
    window.selectWord = function(i){
      if (words[i]) {
        germanInput.value = words[i].german;
        englishInput.value = words[i].english;
      }
    };

    window.deleteWord = function(i){
      if(confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø©ØŸ')){
        words.splice(i,1);
        persist();
        renderList();
      }
    };

    // Add word
    addBtn.addEventListener('click', ()=>{
      const g = germanInput.value.trim();
      const e = englishInput.value.trim();
      if(!g || !e){ alert('ÙŠØ¬Ø¨ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚Ù„ÙŠÙ†'); return; }
      words.push({german:g, english:e}); 
      persist(); 
      renderList(); 
      germanInput.value=''; 
      englishInput.value='';
      germanInput.focus();
    });

    // Pronunciation
    pronBtn.addEventListener('click', ()=>{ 
      const text = germanInput.value.trim();
      if (text) pronounce(text); 
    });

    function pronounce(text){
      if(!text) return; 
      if('speechSynthesis' in window){ 
        const ut = new SpeechSynthesisUtterance(text);
        ut.lang = 'de-DE'; 
        ut.rate = 0.9;
        window.speechSynthesis.cancel(); 
        window.speechSynthesis.speak(ut);
      } else {
        alert('Ù…ÙŠØ²Ø© Ø§Ù„Ù†Ø·Ù‚ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­');
      }
    }

    // Clear inputs
    clearInputsBtn.addEventListener('click', ()=>{
      germanInput.value = '';
      englishInput.value = '';
      germanInput.focus();
    });

    // Clear all words
    clearAllBtn.addEventListener('click', ()=>{
      if(words.length === 0) return;
      if(confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„Ù…Ø§Øª (${words.length} ÙƒÙ„Ù…Ø©)?`)){
        words=[];
        persist();
        renderList();
      }
    });

    // Shuffle words
    shuffleWordsBtn.addEventListener('click', ()=>{
      words = shuffle([...words]);
      persist();
      renderList();
    });

    // Save/load
    saveBtn.addEventListener('click', ()=>{
      const data = JSON.stringify(words, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'german_words.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    loadBtn.addEventListener('click', ()=> fileInput.click());
    
    fileInput.addEventListener('change', ()=>{
      const f = fileInput.files[0]; 
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{ 
          const data = JSON.parse(reader.result); 
          if(Array.isArray(data)){
            words = data.filter(item => item.german && item.english && 
                     typeof item.german === 'string' && 
                     typeof item.english === 'string');
            persist(); 
            renderList(); 
            alert(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${words.length} ÙƒÙ„Ù…Ø©`);
          } else {
            alert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ù„Ù JSON Ù…ØµÙÙˆÙØ©');
          }
        } catch(e){ 
          alert('Ù…Ù„Ù JSON ØºÙŠØ± ØµØ§Ù„Ø­');
        }
        fileInput.value = '';
      };
      reader.readAsText(f);
    });

    csvBtn.addEventListener('click', ()=>{
      if(words.length === 0){
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§');
        return;
      }
      let out = 'german,english\n';
      words.forEach(w => { 
        out += `"${w.german.replace(/"/g,'""')}","${w.english.replace(/"/g,'""')}"\n`; 
      });
      const blob = new Blob([out], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'german_words.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // ===== QUIZ FUNCTIONS =====
    function updateQuizStats() {
      quizRemainingEl.textContent = quizQueue.length;
      const accuracy = quizAttempts > 0 ? Math.round((quizCorrect / quizAttempts) * 100) : 0;
      quizAccuracyEl.textContent = `${accuracy}%`;
      quizScoreEl.textContent = `${quizCorrect}/${quizAttempts}`;
    }

    startQuizBtn.addEventListener('click', startQuiz);
    nextQuizBtn.addEventListener('click', nextQuizQuestion);
    endQuizBtn.addEventListener('click', endQuiz);

    function startQuiz() {
      if(words.length < 2){ 
        alert('Ø£Ø¶Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙƒÙ„Ù…ØªÙŠÙ† Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        document.querySelector('[data-page="editor"]').click();
        return; 
      }
      
      quizActive = true;
      quizCorrect = 0; 
      quizAttempts = 0; 
      
      const limit = parseInt(exerciseLimit.value) || 20;
      const quizWords = words.slice(-limit);
      
      if(quizWords.length < 2){
        alert(`ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ${2 - quizWords.length} ÙƒÙ„Ù…Ø§Øª Ø£Ø®Ø±Ù‰ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±`);
        return;
      }
      
      quizQueue = shuffle([...quizWords]);
      
      // Update UI
      startQuizBtn.style.display = 'none';
      nextQuizBtn.style.display = 'inline-block';
      endQuizBtn.style.display = 'inline-block';
      
      nextQuizQuestion();
    }

    function nextQuizQuestion() {
      if(quizQueue.length === 0){ 
        endQuiz();
        return; 
      }
      
      currentQuizWord = quizQueue.pop();
      quizPromptEl.innerHTML = `Ù…Ø§ Ù‡ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© Ù„Ù€:<br><strong style="color:#ffcccc;font-size:20px;margin-top:8px;display:block">${escapeHtml(currentQuizWord.english)}</strong>`;
      
      const numOpts = Math.max(2, Math.min(6, parseInt(optsCount.value) || 4));
      const limit = parseInt(exerciseLimit.value) || 20;
      const quizWords = words.slice(-limit);
      const choices = buildChoices(currentQuizWord.german, numOpts, quizWords.map(w => w.german));
      renderQuizOptions(choices);
      
      if(document.getElementById('usePron').checked) {
        setTimeout(() => pronounce(currentQuizWord.german), 300);
      }
      
      updateQuizStats();
    }

    function renderQuizOptions(choices){
      quizOptsEl.innerHTML='';
      choices.forEach(c => {
        const opt = document.createElement('div');
        opt.className = 'quiz-option';
        opt.textContent = c;
        opt.onclick = () => quizAnswer(c, opt);
        quizOptsEl.appendChild(opt);
      });
    }

    function quizAnswer(choice, el){
      if(el.classList.contains('correct') || el.classList.contains('wrong')) return;
      
      quizAttempts++; 
      const allOptions = document.querySelectorAll('.quiz-option');
      
      if(choice === currentQuizWord.german){
        quizCorrect++; 
        el.classList.add('correct');
        setTimeout(() => { 
          allOptions.forEach(opt => opt.style.pointerEvents = 'none');
          setTimeout(nextQuizQuestion, 800);
        }, 300);
      } else { 
        el.classList.add('wrong');
        
        // Record mistake
        addMistake('quiz', currentQuizWord.english, currentQuizWord.german, choice);
        
        // Highlight correct answer
        allOptions.forEach(opt => {
          if(opt.textContent === currentQuizWord.german) {
            opt.classList.add('correct');
          }
          opt.style.pointerEvents = 'none';
        });
        
        setTimeout(() => {
          allOptions.forEach(opt => opt.style.pointerEvents = 'none');
          setTimeout(nextQuizQuestion, 800);
        }, 1200);
      } 
      
      updateQuizStats();
    }

    function endQuiz() {
      quizActive = false;
      
      quizPromptEl.innerHTML = `
        <div style="text-align:center">
          <div style="font-size:36px">${quizCorrect === quizAttempts ? 'ğŸ‰' : 'ğŸ“Š'}</div>
          <div style="font-size:20px;color:#ffcccc;margin:8px 0">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù†ØªÙ‡Ù‰!</div>
          <div style="font-size:16px;color:var(--muted)">${quizCorrect} Ù…Ù† ${quizAttempts} Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©</div>
          <div style="font-size:14px;color:#19b56b;margin-top:8px">Ø§Ù„Ø¯Ù‚Ø©: ${quizAttempts > 0 ? Math.round((quizCorrect / quizAttempts) * 100) : 0}%</div>
        </div>
      `;
      
      quizOptsEl.innerHTML = '';
      
      startQuizBtn.style.display = 'inline-block';
      nextQuizBtn.style.display = 'none';
      endQuizBtn.style.display = 'none';
      
      updateQuizStats();
    }

    // ===== WRITING EXERCISE FUNCTIONS =====
    function updateWritingStats() {
      writingRemainingEl.textContent = writingQueue.length;
      const accuracy = writingAttempts > 0 ? Math.round((writingCorrect / writingAttempts) * 100) : 0;
      writingAccuracyEl.textContent = `${accuracy}%`;
      writingScoreEl.textContent = `${writingCorrect}/${writingAttempts}`;
    }

    startWritingBtn.addEventListener('click', startWriting);
    checkAnswerBtn.addEventListener('click', checkWritingAnswer);
    nextWritingBtn.addEventListener('click', nextWritingQuestion);
    showAnswerBtn.addEventListener('click', showWritingAnswer);
    endWritingBtn.addEventListener('click', endWriting);
    writingInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && writingActive && !writingInput.disabled) {
        checkWritingAnswer();
      }
    });

    function startWriting() {
      if(words.length < 2){ 
        alert('Ø£Ø¶Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙƒÙ„Ù…ØªÙŠÙ† Ù„Ø¨Ø¯Ø¡ ØªÙ…Ø±ÙŠÙ† Ø§Ù„ÙƒØªØ§Ø¨Ø©');
        document.querySelector('[data-page="editor"]').click();
        return; 
      }
      
      writingActive = true;
      writingCorrect = 0; 
      writingAttempts = 0; 
      
      const limit = parseInt(exerciseLimit.value) || 20;
      const writingWords = words.slice(-limit);
      
      if(writingWords.length < 2){
        alert(`ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ${2 - writingWords.length} ÙƒÙ„Ù…Ø§Øª Ø£Ø®Ø±Ù‰ Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ…Ø±ÙŠÙ†`);
        return;
      }
      
      writingQueue = shuffle([...writingWords]);
      
      // Update UI
      startWritingBtn.style.display = 'none';
      checkAnswerBtn.style.display = 'inline-block';
      nextWritingBtn.style.display = 'none';
      showAnswerBtn.style.display = 'inline-block';
      endWritingBtn.style.display = 'inline-block';
      writingInput.disabled = false;
      writingInput.focus();
      
      nextWritingQuestion();
    }

    function nextWritingQuestion() {
      if(writingQueue.length === 0){ 
        endWriting();
        return; 
      }
      
      currentWritingWord = writingQueue.pop();
      writingPromptEl.innerHTML = `Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© Ù„Ù€:<br><strong style="color:#ffcccc;font-size:22px;margin-top:8px;display:block">${escapeHtml(currentWritingWord.english)}</strong>`;
      writingHintEl.textContent = 'Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø£Ø¯Ù†Ø§Ù‡ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ­Ù‚Ù‚" Ø£Ùˆ Ø§Ø¶ØºØ· Enter';
      
      writingInput.value = '';
      writingFeedback.textContent = '';
      writingFeedback.className = 'writing-feedback';
      writingInput.disabled = false;
      writingInput.focus();
      
      checkAnswerBtn.style.display = 'inline-block';
      nextWritingBtn.style.display = 'none';
      showAnswerBtn.style.display = 'inline-block';
      
      if(document.getElementById('usePron').checked) {
        setTimeout(() => pronounce(currentWritingWord.german), 500);
      }
      
      updateWritingStats();
    }

    function normalizeText(text) {
      return text.toLowerCase().trim()
        .replace(/\s+/g, ' ')
        .replace(/Ã¤/g, 'ae')
        .replace(/Ã¶/g, 'oe')
        .replace(/Ã¼/g, 'ue')
        .replace(/ÃŸ/g, 'ss');
    }

    function checkWritingAnswer() {
      if (!currentWritingWord || !writingActive) return;
      
      const userAnswer = writingInput.value.trim();
      if (!userAnswer) {
        writingFeedback.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¥Ø¬Ø§Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹';
        writingFeedback.className = 'writing-feedback incorrect';
        return;
      }
      
      writingAttempts++;
      writingInput.disabled = true;
      
      const correctAnswer = currentWritingWord.german;
      const normalizedUserAnswer = normalizeText(userAnswer);
      const normalizedCorrectAnswer = normalizeText(correctAnswer);
      
      // Check if answer is correct (with spelling tolerance if enabled)
      let isCorrect = false;
      if (spellingTolerance.checked) {
        isCorrect = normalizedUserAnswer === normalizedCorrectAnswer ||
                   Math.abs(normalizedUserAnswer.length - normalizedCorrectAnswer.length) <= 2;
        
        if (!isCorrect) {
          const distance = levenshteinDistance(normalizedUserAnswer, normalizedCorrectAnswer);
          isCorrect = distance <= 1;
        }
      } else {
        isCorrect = normalizedUserAnswer === normalizedCorrectAnswer;
      }
      
      if (isCorrect) {
        writingCorrect++;
        writingFeedback.innerHTML = `
          <div style="font-size:20px">âœ… ØµØ­ÙŠØ­!</div>
          <div style="margin-top:8px;font-size:16px">"${escapeHtml(correctAnswer)}" Ù‡ÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</div>
        `;
        writingFeedback.className = 'writing-feedback correct';
        
        // Auto proceed to next question after delay
        setTimeout(() => {
          if (writingQueue.length > 0) {
            nextWritingQuestion();
          } else {
            endWriting();
          }
        }, 1500);
      } else {
        writingFeedback.innerHTML = `
          <div style="font-size:20px">âŒ ØºÙŠØ± ØµØ­ÙŠØ­</div>
          <div style="margin-top:8px;font-size:14px">Ø¥Ø¬Ø§Ø¨ØªÙƒ: "${escapeHtml(userAnswer)}"</div>
        `;
        writingFeedback.className = 'writing-feedback incorrect';
        
        // Record mistake
        addMistake('writing', currentWritingWord.english, currentWritingWord.german, userAnswer);
        
        checkAnswerBtn.style.display = 'none';
        nextWritingBtn.style.display = 'inline-block';
        
        // Auto show answer if enabled
        if (document.getElementById('usePron').checked) {
          setTimeout(showWritingAnswer, 1000);
        }
      }
      
      updateWritingStats();
    }

    function showWritingAnswer() {
      if (!currentWritingWord) return;
      
      writingFeedback.innerHTML = `
        <div style="font-size:18px">ğŸ‘ï¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</div>
        <div class="writing-answer">${escapeHtml(currentWritingWord.german)}</div>
        <div style="margin-top:8px;font-size:13px;color:#ffcccc">Ù…Ø¹Ù†Ù‰: ${escapeHtml(currentWritingWord.english)}</div>
      `;
      writingFeedback.className = 'writing-feedback show-answer';
      
      // Pronounce the correct answer
      if (document.getElementById('usePron').checked) {
        pronounce(currentWritingWord.german);
      }
    }

    function endWriting() {
      writingActive = false;
      
      writingPromptEl.innerHTML = `
        <div style="text-align:center">
          <div style="font-size:36px">${writingCorrect === writingAttempts ? 'ğŸ‰' : 'ğŸ“Š'}</div>
          <div style="font-size:20px;color:#ffcccc;margin:8px 0">ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† ØªÙ…Ø±ÙŠÙ† Ø§Ù„ÙƒØªØ§Ø¨Ø©!</div>
          <div style="font-size:16px;color:var(--muted)">${writingCorrect} Ù…Ù† ${writingAttempts} Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©</div>
          <div style="font-size:14px;color:#19b56b;margin-top:8px">Ø§Ù„Ø¯Ù‚Ø©: ${writingAttempts > 0 ? Math.round((writingCorrect / writingAttempts) * 100) : 0}%</div>
        </div>
      `;
      
      writingHintEl.textContent = 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ…Ø±ÙŠÙ†" Ù„Ø¨Ø¯Ø¡ ØªÙ…Ø±ÙŠÙ† ÙƒØªØ§Ø¨Ø© Ø¬Ø¯ÙŠØ¯';
      writingInput.value = '';
      writingInput.disabled = true;
      writingFeedback.textContent = '';
      writingFeedback.className = 'writing-feedback';
      
      startWritingBtn.style.display = 'inline-block';
      checkAnswerBtn.style.display = 'none';
      nextWritingBtn.style.display = 'none';
      showAnswerBtn.style.display = 'none';
      endWritingBtn.style.display = 'none';
      
      updateWritingStats();
    }

    // ===== MEMORY GAME FUNCTIONS - USES LAST 8 WORDS =====
    startMemoryBtn.addEventListener('click', startMemoryGame);
    restartMemoryBtn.addEventListener('click', restartMemoryGame);
    
    function startMemoryGame() {
      if(words.length < 4){ 
        alert('Ø£Ø¶Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 4 ÙƒÙ„Ù…Ø§Øª Ù„Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©');
        document.querySelector('[data-page="editor"]').click();
        return; 
      }
      
      memoryActive = true;
      memoryMoves = 0;
      memoryMatched = 0;
      memoryStartTime = Date.now();
      flippedCards = [];
      canFlip = true;
      
      // Use the last 8 words (4 pairs)
      const lastWords = words.slice(-8);
      
      if (lastWords.length < 4) {
        alert('ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ 4 ÙƒÙ„Ù…Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙÙŠ Ø¢Ø®Ø± 8 ÙƒÙ„Ù…Ø§Øª');
        return;
      }
      
      // Use exactly 4 pairs from the last 8 words
      // If we have less than 8 words, use all available words
      const gameWords = lastWords.length >= 8 ? lastWords.slice(-8) : lastWords;
      
      // Create card pairs (German-English)
      memoryCards = [];
      gameWords.forEach(word => {
        memoryCards.push({
          id: Date.now() + Math.random(),
          type: 'german',
          content: word.german,
          pairId: word.german + word.english,
          matched: false
        });
        memoryCards.push({
          id: Date.now() + Math.random() + 1,
          type: 'english',
          content: word.english,
          pairId: word.german + word.english,
          matched: false
        });
      });
      
      // If we have odd number of words, remove one pair to make it even
      if (memoryCards.length % 2 !== 0) {
        memoryCards.pop();
      }
      
      memoryCards = shuffle(memoryCards);
      
      // Update UI
      startMemoryBtn.style.display = 'none';
      restartMemoryBtn.style.display = 'inline-block';
      memoryComplete.style.display = 'none';
      renderMemoryGrid();
      startMemoryTimer();
      updateMemoryStats();
    }
    
    function restartMemoryGame() {
      stopMemoryGame();
      startMemoryGame();
    }
    
    function stopMemoryGame() {
      memoryActive = false;
      if (memoryTimer) {
        clearInterval(memoryTimer);
        memoryTimer = null;
      }
    }
    
    function startMemoryTimer() {
      if (memoryTimer) clearInterval(memoryTimer);
      memoryTimer = setInterval(updateMemoryTimer, 1000);
    }
    
    function updateMemoryTimer() {
      if (!memoryActive) return;
      const elapsed = Math.floor((Date.now() - memoryStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      memoryTimeEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function updateMemoryStats() {
      memoryMovesEl.textContent = memoryMoves;
      memoryMatchedEl.textContent = memoryMatched;
    }
    
    function renderMemoryGrid() {
      memoryGrid.innerHTML = '';
      
      if (memoryCards.length === 0) {
        memoryGrid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:30px;color:var(--muted);font-size:14px">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„Ø¹Ø¨Ø© (ØªØ­ØªØ§Ø¬ 4 ÙƒÙ„Ù…Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)</div>';
        return;
      }
      
      memoryCards.forEach((card, index) => {
        const cardElement = document.createElement('div');
        cardElement.className = 'memory-card';
        if (card.matched) {
          cardElement.classList.add('matched');
        }
        
        const cardInner = document.createElement('div');
        cardInner.className = 'memory-card-inner';
        
        const cardBack = document.createElement('div');
        cardBack.className = 'card-back';
        cardBack.textContent = '?';
        
        const cardFront = document.createElement('div');
        cardFront.className = 'card-front';
        cardFront.innerHTML = `
          <div class="card-flag">${card.type === 'german' ? 'ğŸ‡©ğŸ‡ª' : 'ğŸ‡¬ğŸ‡§'}</div>
          <div class="card-text">${escapeHtml(card.content)}</div>
        `;
        
        cardInner.appendChild(cardBack);
        cardInner.appendChild(cardFront);
        cardElement.appendChild(cardInner);
        
        cardElement.addEventListener('click', () => flipMemoryCard(index, cardElement));
        memoryGrid.appendChild(cardElement);
      });
    }
    
    function flipMemoryCard(index, cardElement) {
      if (!memoryActive || !canFlip || flippedCards.includes(index) || memoryCards[index].matched) return;
      
      // Flip the card
      cardElement.classList.add('flipped');
      flippedCards.push(index);
      
      if (flippedCards.length === 2) {
        memoryMoves++;
        canFlip = false;
        updateMemoryStats();
        
        const card1 = memoryCards[flippedCards[0]];
        const card2 = memoryCards[flippedCards[1]];
        
        if (card1.pairId === card2.pairId) {
          // Match found!
          memoryCards[flippedCards[0]].matched = true;
          memoryCards[flippedCards[1]].matched = true;
          memoryMatched++;
          
          // Visual feedback for match
          setTimeout(() => {
            const card1Element = document.querySelectorAll('.memory-card')[flippedCards[0]];
            const card2Element = document.querySelectorAll('.memory-card')[flippedCards[1]];
            
            card1Element.classList.add('matched');
            card2Element.classList.add('matched');
            
            flippedCards = [];
            canFlip = true;
            updateMemoryStats();
            
            // Check if game is complete
            if (memoryMatched === memoryCards.length / 2) {
              endMemoryGame();
            }
          }, 600);
        } else {
          // No match - flip back after delay
          setTimeout(() => {
            const card1Element = document.querySelectorAll('.memory-card')[flippedCards[0]];
            const card2Element = document.querySelectorAll('.memory-card')[flippedCards[1]];
            
            card1Element.classList.remove('flipped');
            card2Element.classList.remove('flipped');
            
            // Add shake animation for wrong match
            card1Element.classList.add('shake');
            card2Element.classList.add('shake');
            setTimeout(() => {
              card1Element.classList.remove('shake');
              card2Element.classList.remove('shake');
            }, 500);
            
            flippedCards = [];
            canFlip = true;
          }, 1000);
        }
      }
    }
    
    function endMemoryGame() {
      memoryActive = false;
      clearInterval(memoryTimer);
      
      const elapsed = Math.floor((Date.now() - memoryStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      finalMovesEl.textContent = memoryMoves;
      finalTimeEl.textContent = timeString;
      memoryComplete.style.display = 'block';
    }

    // ===== MISTAKE REVIEW EVENT LISTENERS =====
    startReviewBtn.addEventListener('click', startMistakeReview);
    clearMistakesBtn.addEventListener('click', () => {
      if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ØŸ')) {
        mistakes = [];
        saveMistakes();
      }
    });
    
    checkReviewAnswerBtn.addEventListener('click', () => {
      if (currentReviewMistake.type === 'writing') {
        checkReviewWritingAnswer();
      }
    });
    
    nextMistakeBtn.addEventListener('click', () => {
      nextReviewQuestion();
    });
    
    showReviewAnswerBtn.addEventListener('click', () => {
      if (currentReviewMistake.type === 'quiz') {
        const allOptions = document.querySelectorAll('#review-opts .quiz-option');
        allOptions.forEach(opt => {
          if (opt.textContent === currentReviewMistake.correct) {
            opt.classList.add('correct');
          }
          opt.style.pointerEvents = 'none';
        });
        checkReviewAnswerBtn.style.display = 'none';
        nextMistakeBtn.style.display = 'inline-block';
      } else if (currentReviewMistake.type === 'writing') {
        reviewAnswerInput.value = currentReviewMistake.correct;
        reviewAnswerInput.disabled = true;
        checkReviewAnswerBtn.style.display = 'none';
        nextMistakeBtn.style.display = 'inline-block';
      }
    });
    
    endReviewBtn.addEventListener('click', endMistakeReview);
    
    reviewAnswerInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && reviewActive) {
        checkReviewWritingAnswer();
      }
    });

    // ===== UTILITY FUNCTIONS =====
    function levenshteinDistance(a, b) {
      const matrix = [];
      
      for (let i = 0; i <= b.length; i++) {
        matrix[i] = [i];
      }
      
      for (let j = 0; j <= a.length; j++) {
        matrix[0][j] = j;
      }
      
      for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
          if (b.charAt(i - 1) === a.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j] + 1
            );
          }
        }
      }
      
      return matrix[b.length][a.length];
    }

    function shuffle(arr){ 
      const newArr = [...arr];
      for(let i = newArr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
      }
      return newArr;
    }

    // Settings
    document.getElementById('usePron').addEventListener('change', saveSettings);
    optsCount.addEventListener('change', saveSettings);
    exerciseLimit.addEventListener('change', saveSettings);
    spellingTolerance.addEventListener('change', saveSettings);

    document.getElementById('reset-settings').addEventListener('click', () => {
      if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªØŸ')){
        settings = {
          optionsCount:4, 
          usePron:true, 
          exerciseLimit:20, 
          spellingTolerance:true
        };
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        initSettings();
        alert('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
      }
    });

    document.getElementById('export-data').addEventListener('click', () => {
      const allData = {
        words: words,
        settings: settings,
        mistakes: mistakes,
        version: '6.0',
        exportDate: new Date().toISOString()
      };
      
      const data = JSON.stringify(allData, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'german_trainer_backup.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      // Ctrl+S to save
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's'){
        e.preventDefault();
        saveBtn.click();
      }
      
      // Enter to add word (when in editor page and inputs focused)
      if(e.key === 'Enter' && document.activeElement === germanInput){
        addBtn.click();
      }
      
      // Space to pronounce (when german input focused)
      if(e.key === ' ' && document.activeElement === germanInput && germanInput.value.trim()){
        e.preventDefault();
        pronounce(germanInput.value.trim());
      }
    });

    // Initialize
    initSettings();
    renderList();
    updateQuizStats();
    updateWritingStats();
    updateMistakeReviewUI();
  </script>
</body>
</html>